<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SWS/OPSå“¡å·¥æ‰“å¡ç³»çµ±</title>
    <style>
        :root { --primary: #000; --bg: #f2f2f7; --success: #34c759; --blue: #007aff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin:0; font-family:-apple-system, 'SF Pro Display', sans-serif; background: var(--bg); color: #1c1c1e; }
        .card { background:white; width:92%; max-width:400px; padding:25px; border-radius:28px; box-shadow:0 10px 30px rgba(0,0,0,0.08); text-align:center; margin: 20px auto; display: none; }
        .active { display: block !important; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        h2 { margin-bottom:20px; font-size:22px; font-weight:700; }
        button { width:100%; padding:18px; border-radius:16px; border:none; background:var(--primary); color:white; font-size:16px; font-weight:600; margin-top:10px; cursor:pointer; }
        button:active { opacity: 0.7; transform: scale(0.98); }
        button:disabled { background: #ccc !important; }
        .secondary { background:#e5e5e7; color:#000; }
        .home-link { color: var(--blue); cursor: pointer; display: block; margin-top: 15px; font-size: 15px; font-weight: 600; text-decoration: none; }
        #btnIn { background: #FFFBCC; color: #856404; border: 1px solid #ffeeba; }
        #btnOut { background: #CCE5FF; color: #004085; border: 1px solid #b8daff; }
        .menu-btn { text-align:left; padding:18px; background:#fff; margin-bottom:12px; border-radius:18px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .record-item { text-align:left; padding:15px; border-bottom:1px solid #f2f2f7; font-size:14px; position: relative; }
        .tag { font-size:11px; padding:4px 10px; border-radius:8px; font-weight:800; display: inline-block; min-width: 50px; text-align: center; }
        .tag-in { background: #FFFBCC; color: #856404; border: 0.5px solid #ffeeba; }
        .tag-out { background: #CCE5FF; color: #004085; border: 0.5px solid #b8daff; }
        input, textarea { width:100%; padding:18px; margin-bottom:15px; border-radius:16px; border:1.5px solid #d1d1d6; font-size:16px; outline:none; }
        .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; backdrop-filter: blur(3px); }
        .big-check { font-size: 70px; margin-bottom: 10px; }
        .date-group { border: 1px solid #e5e5e7; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; }
        .date-header { background: #f9f9fb; padding: 15px; text-align: left; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .date-content { display: none; padding: 0 15px; background: #fff; border-top: 1px solid #eee; }
        .date-content.open { display: block; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay"><b>âŒ› è™•ç†ä¸­...</b></div>

<div class="card active" id="loginBox">
    <div style="font-size: 50px; margin-bottom: 15px;">ğŸ’¼</div>
    <h2>SWS/OPS æ‰“å¡ç³»çµ±</h2>
    <input id="name" placeholder="ç™»å…¥åç¨±" autocomplete="off">
    <input id="pin" type="password" placeholder="PINç¢¼" inputmode="numeric">
    <button id="loginBtn" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
</div>

<div class="card" id="menuBox">
    <h2 id="userHello">ä½ å¥½</h2>
    <div class="menu-btn" onclick="showBox('clockInBox')"><div>ğŸ“ <b>æˆ‘è¦æ‰“å¡ï¼</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="startSchedFlow()"><div>ğŸ“… <b>æˆ‘æƒ³ç‡æ›´ï¼</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="startRecordFlow()"><div>ğŸ“œ <b>æ‰“å¡ç´€éŒ„</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="showBox('supportBox')"><div>ğŸ› ï¸ <b>æŠ€è¡“æ”¯æ´</b></div><span>â¯</span></div>
    <button class="secondary" onclick="location.reload()" style="margin-top:20px;">ç™»å‡ºç³»çµ±</button>
</div>

<div class="card" id="clockInBox">
    <h2>ä»Šæ—¥æ›´æ¬¡</h2>
    <div id="todaySchedules"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<div class="card" id="typeBox">
    <h2 id="selectedJobTitle">åœ°é»</h2>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleCapture(this)" style="display:none">
    <button id="btnIn" onclick="triggerCamera('ç¿»å·¥')">ğŸŒ… ç¿»å·¥æ‰“å¡</button>
    <button id="btnOut" onclick="triggerCamera('æ”¶å·¥')">ğŸŒ‡ æ”¶å·¥æ‰“å¡</button>
    <button class="secondary" onclick="showBox('clockInBox')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="successBox">
    <div class="big-check">âœ…</div>
    <h2 id="successType">æ‰“å¡æˆåŠŸ</h2>
    <p id="successTime" style="font-size:20px; font-weight:bold; margin:10px 0;"></p>
    <p id="successDetail" style="color:#666; font-size:14px;"></p>
    <button onclick="showBox('menuBox')">è¿”å›ä¸»é </button>
</div>

<div class="card" id="boxLoc">
    <h2>é¸æ“‡åœ°é»</h2>
    <div id="listLoc"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<div class="card" id="boxYM">
    <h2 id="titleYM">é¸æ“‡æœˆä»½</h2>
    <div id="listYM"></div>
    <button class="secondary" onclick="showBox('boxLoc')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="boxFinal">
    <h2 id="titleFinal">æ›´æ¬¡è©³æƒ…</h2>
    <div id="listFinal" style="max-height:400px; overflow-y:auto;"></div>
    <button class="secondary" onclick="showBox('boxYM')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="recordLocBox">
    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ¢</div>
    <h2>é¸æ“‡ç´€éŒ„åœ°é»</h2>
    <div id="listRecordLoc"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›ä¸»é </button>
</div>

<div class="card" id="recordMonthBox">
    <h2 id="titleRecordYM">é¸æ“‡æœˆä»½</h2>
    <div id="listRecordYM"></div>
    <button class="secondary" onclick="showBox('recordLocBox')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="recordFinalBox">
    <h2 id="titleRecordFinal">æ‰“å¡ç´€éŒ„</h2>
    <div id="listRecordFinal" style="max-height:450px; overflow-y:auto; padding:5px;"></div>
    <button class="secondary" onclick="showBox('recordMonthBox')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="supportBox">
    <h2>æŠ€è¡“æ”¯æ´</h2>
    <p style="font-size: 14px; color: #ff3b30; font-weight: bold; margin-bottom: 15px;">âš ï¸ æœ‰ç·Šæ€¥äº‹è«‹è‡ªè¡Œè¯çµ¡Elmo</p>
    <textarea id="supportMsg" rows="4" placeholder="è«‹è¼¸å…¥ç•™è¨€..."></textarea>
    <button id="supportBtn" onclick="submitSupport()">æäº¤ç•™è¨€</button>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDTT86mpGJJMByToRMi7b8jjI0LoNJarNo",
    authDomain: "sws-ops.firebaseapp.com",
    projectId: "sws-ops",
    storageBucket: "sws-ops.firebasestorage.app",
    messagingSenderId: "985280948590",
    appId: "1:985280948590:web:3aad1539136659b4dc797f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz_b2CB8lwTIeCZRLfQxdzWZYui0764G4qRNn_82FDhhPtJkSIyKipk2KNRp1k36CTegw/exec";
let currentUser = "";
let cachedData = null;
let curL = "";
let curRecordLoc = "";
let selectedSchedule = null;
let clockType = "";

// --- ã€æ–°å¢ï¼šæ™ºèƒ½é€£æ›´åˆ¤å®šå·¥å…·ã€‘ ---
const GAP_LIMIT = 90; // 90 åˆ†é˜åˆ¤å®šé–“éš”

// è¼”åŠ©ï¼šå°‡ "09:00" è½‰åšåˆ†é˜æ•¸
function timeToMins(tStr) {
    if (!tStr) return 0;
    // æ”¯æ´ "09:00 - 18:00" å–å‰é¢å—°å€‹
    const timePart = tStr.split('-')[0].trim(); 
    const parts = timePart.split(':');
    if (parts.length < 2) return 0;
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

// è¼”åŠ©ï¼šå°‡ "09:00 - 18:00" å–å¾Œé¢å—°å€‹çµæŸæ™‚é–“
function timeToEndMins(tStr) {
    if (!tStr || !tStr.includes('-')) return timeToMins(tStr);
    const timePart = tStr.split('-')[1].trim();
    const parts = timePart.split(':');
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

// --- ã€1. é¸æ“‡æ›´æ¬¡é‚è¼¯ã€‘ ---
window.selectSpecificJob = (d, t, l, e) => {
    // è¨­å®šç›®å‰é¸ä¸­å˜…æ›´æ¬¡è³‡æ–™ [æ—¥æœŸ, æ™‚é–“, ?, åœ°é», äº‹ä»¶å]
    selectedSchedule = [d, t, "", l, e]; 
    
    const uniqueKey = e + " [" + t + "]";
    
    // æª¢æŸ¥ä¿‚å’ªå·²ç¶“æ‰“å’—å¡
    const hasIn = (cachedData.records || []).some(r => r[0] === d && r[5] === uniqueKey && r[3] === "ç¿»å·¥");
    const hasOut = (cachedData.records || []).some(r => r[0] === d && r[5] === uniqueKey && r[3] === "æ”¶å·¥");

    document.getElementById("selectedJobTitle").innerText = l;
    
    const btnIn = document.getElementById("btnIn");
    const btnOut = document.getElementById("btnOut");

    // æ›´æ–°æ£å˜…ç‹€æ…‹
    btnIn.disabled = hasIn; 
    btnIn.innerText = hasIn ? "âœ… å·²å®Œæˆç¿»å·¥" : "ğŸŒ… ç¿»å·¥æ‰“å¡";
    btnIn.style.opacity = hasIn ? "0.5" : "1";

    btnOut.disabled = hasOut; 
    btnOut.innerText = hasOut ? "âœ… å·²å®Œæˆæ”¶å·¥" : "ğŸŒ‡ æ”¶å·¥æ‰“å¡";
    btnOut.style.opacity = hasOut ? "0.5" : "1";

    showBox('typeBox'); 
};

// --- ã€2. ä»‹é¢æ¸²æŸ“é‚è¼¯ (å”¯ä¸€æ­£ç¢ºç‰ˆ)ã€‘ ---
window.renderUI = () => {
    const hkt = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
    const formatDate = (d) => {
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        return `${day}-${month}-${d.getFullYear()}`;
    };

    const dates = [
        { label: "æ˜¨æ—¥", date: formatDate(new Date(new Date(hkt).setDate(hkt.getDate() - 1))) },
        { label: "ä»Šæ—¥", date: formatDate(hkt) },
        { label: "ç¿Œæ—¥", date: formatDate(new Date(new Date(hkt).setDate(hkt.getDate() + 1))) }
    ];

    let html = "";
    dates.forEach(group => {
        const dayScheds = (cachedData.allSchedules || [])
            .filter(s => String(s[0]).trim() === group.date)
            .sort((a, b) => timeToMins(a[1]) - timeToMins(b[1]));
        
        html += `<div class="date-group">
            <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
                <span>ğŸ“… <b>${group.label}</b> (${group.date})</span>
                <span style="color:#007aff; font-size:12px;">å±•é–‹/æ”¶æ‘º â–¼</span>
            </div>
            <div class="date-content ${group.label === 'ä»Šæ—¥' ? 'open' : ''}">`;

        if (dayScheds.length === 0) {
            html += `<p style="color:#ccc; padding:10px; text-align:center;">ï¼ˆç„¡å®‰æ’æ›´æ¬¡ï¼‰</p>`;
        } else {
            dayScheds.forEach((s) => {
                const uniqueKey = s[4] + " [" + s[1] + "]";
                const hasIn = (cachedData.records || []).some(r => r[0] === s[0] && r[5] === uniqueKey && r[3] === "ç¿»å·¥");
                const hasOut = (cachedData.records || []).some(r => r[0] === s[0] && r[5] === uniqueKey && r[3] === "æ”¶å·¥");
                
                let status = hasOut ? "âœ… å·²å®Œæ›´" : (hasIn ? "ğŸŒ… å·²ç¿»å·¥" : "â¯");
                
                html += `<div class="menu-btn" style="opacity:${hasOut?'0.5':'1'}" onclick="selectSpecificJob('${s[0]}','${s[1]}','${s[3]}','${s[4]}')">
                    <div><b>${s[3]}</b><br><small>${s[1]} ${s[4]}</small></div>
                    <span style="color:#007aff; font-weight:bold;">${status}</span>
                </div>`;
            });
        }
        html += `</div></div>`;
    });
    document.getElementById("todaySchedules").innerHTML = html;
};

window.startSchedFlow = () => {
    const locs = [...new Set(cachedData.allSchedules.map(s => s[3]))];
    let h = "";
    locs.forEach(l => h += `<div class="menu-btn" onclick="chooseLoc('${l}')"><b>${l}</b><span>â¯</span></div>`);
    document.getElementById("listLoc").innerHTML = h || "ç„¡è³‡æ–™";
    window.showBox('boxLoc');
};

window.chooseLoc = (l) => {
    curL = l;
    document.getElementById("titleYM").innerText = l;
    const ymSet = [...new Set(cachedData.allSchedules.filter(s => s[3] === curL).map(s => {
        const p = parseDateStr(s[0]);
        return p[0] + "å¹´" + p[1] + "æœˆ";
    }))].sort().reverse();
    let h = "";
    ymSet.forEach(ym => h += `<div class="menu-btn" onclick="chooseYM('${ym}')"><b>${ym}</b><span>â¯</span></div>`);
    document.getElementById("listYM").innerHTML = h;
    window.showBox('boxYM');
};

window.chooseYM = (ym) => {
    const yNum = ym.split("å¹´")[0];
    const mNum = ym.split("å¹´")[1].replace("æœˆ","");
    document.getElementById("titleFinal").innerText = curL + " (" + ym + ")";
    const list = cachedData.allSchedules.filter(s => {
        const p = parseDateStr(s[0]);
        return s[3] === curL && p[0] === yNum && p[1] === mNum;
    }).sort((a,b) => parseInt(parseDateStr(b[0])[2]) - parseInt(parseDateStr(a[0])[2]));
    let h = "";
    list.forEach(s => {
        const p = parseDateStr(s[0]);
        const dstr = ("0"+p[2]).slice(-2) + "/" + ("0"+p[1]).slice(-2);
        h += `<div class="record-item"><b>${dstr}</b><br><small>${s[1]} ${s[4]}</small></div>`;
    });
    document.getElementById("listFinal").innerHTML = h;
    window.showBox('boxFinal');
};


window.triggerCamera = (t) => {
    // --- ã€Policy æª¢æŸ¥ï¼šæœªé–‹ç›¸æ©Ÿå‰å…ˆæ“‹ä½ã€‘ ---
    const getHKToday = () => {
        const d = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
        const d0 = String(d.getDate()).padStart(2, '0');
        const m0 = String(d.getMonth() + 1).padStart(2, '0');
        const y = d.getFullYear();
        // è€ƒæ…®åˆ°ä½  Sheet æ ¼å¼åŒ JS æ ¼å¼ï¼Œåšé½Šæ‰€æœ‰å¯èƒ½æ¯”å°
        return [`${d.getDate()}-${d.getMonth()+1}-${y}`, `${d0}-${m0}-${y}`, `${d.getDate()}/${d.getMonth()+1}/${y}`, `${d0}/${m0}/${y}`];
    };

    const hkTodayFormats = getHKToday();
    const todayRecs = cachedData.records.filter(r => {
        const recordDate = String(r[0]).trim();
        return hkTodayFormats.some(f => recordDate === f);
    });
    
    // æ”ä»Šæ—¥æœ€å¾Œä¸€å€‹å‹•ä½œ
    const lastAction = todayRecs.length > 0 ? todayRecs[todayRecs.length - 1][3] : null;

    // æ¢ä»¶ä¸€ï¼šç¬¬ä¸€ç­†ä¸€å®šè¦ä¿‚ã€Œç¿»å·¥ã€
    if (t === "æ”¶å·¥" && !lastAction) {
        alert("âš ï¸ éŒ¯èª¤ï¼šä»Šæ—¥ä»²æœªæœ‰ã€Œç¿»å·¥ã€ç´€éŒ„ï¼Œä½ å¿…é ˆå…ˆæ‰“ç¿»å·¥ï¼");
        return; // ç›´æ¥æˆªæ–·ï¼Œå””æœƒåŸ·è¡Œä¸‹é¢é–‹ç›¸æ©Ÿå˜… Code
    }

    // æ¢ä»¶äºŒï¼šå¿…é ˆäº¤æ›¿ (å””å¯ä»¥é€£çºŒå…©æ¬¡ç¿»å·¥ æˆ– é€£çºŒå…©æ¬¡æ”¶å·¥)
    if (lastAction === t) {
        alert("âš ï¸ éŒ¯èª¤ï¼šä½ æœ€å¾Œä¸€ç­†ç´€éŒ„å·²ç¶“ä¿‚ã€Œ" + lastAction + "ã€ï¼Œè«‹å…ˆæ‰“ã€Œ" + (t === "ç¿»å·¥" ? "æ”¶å·¥" : "ç¿»å·¥") + "ã€ï¼");
        return; // ç›´æ¥æˆªæ–·
    }
    // --- ã€æª¢æŸ¥å®Œç•¢ï¼Œé€šéå…ˆè‡³å‡†å½±ç›¸ã€‘ ---

    clockType = t; // ç¢ºä¿å‘¢åº¦è³¦å€¼æ­£ç¢º
    const btn = t === 'ç¿»å·¥' ? document.getElementById("btnIn") : document.getElementById("btnOut");
    const originalText = btn.innerText;
    btn.innerText = "ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿä¸­...";
    document.getElementById("cameraInput").click();
    setTimeout(() => { btn.innerText = originalText; }, 3000);
};

window.handleCapture = (input) => {
    if (!input.files[0]) return;
    
    // --- ã€æ–°åŠ å…¥ï¼šPolicy æª¢æŸ¥é‚è¼¯ã€‘ ---
    const getHKToday = () => {
        const d = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
        const d0 = String(d.getDate()).padStart(2, '0');
        const m0 = String(d.getMonth() + 1).padStart(2, '0');
        const y = d.getFullYear();
        return [`${d.getDate()}-${d.getMonth()+1}-${y}`, `${d0}-${m0}-${y}`, `${d.getDate()}/${d.getMonth()+1}/${y}`, `${d0}/${m0}/${y}`];
    };

    const hkTodayFormats = getHKToday();
    const todayRecs = cachedData.records.filter(r => {
        const recordDate = String(r[0]).trim();
        return hkTodayFormats.some(f => recordDate === f);
    });
    
    // æ”è¿”ä»Šæ—¥æœ€å¾Œä¸€å€‹ Action
    const lastAction = todayRecs.length > 0 ? todayRecs[todayRecs.length - 1][3] : null;

    // æ¢ä»¶ä¸€ï¼šç¬¬ä¸€ç­†ä¸€å®šè¦ä¿‚ã€Œç¿»å·¥ã€
    if (clockType === "æ”¶å·¥" && !lastAction) {
        alert("âš ï¸ éŒ¯èª¤ï¼šä»Šæ—¥ä»²æœªæœ‰ã€Œç¿»å·¥ã€ç´€éŒ„ï¼Œä½ å¿…é ˆå…ˆæ‰“ç¿»å·¥ï¼");
        input.value = ""; // æ¸…ç©º file input
        return;
    }

    // æ¢ä»¶äºŒï¼šå¿…é ˆäº¤æ›¿ (å””å¯ä»¥é€£çºŒå…©æ¬¡ç¿»å·¥ æˆ– é€£çºŒå…©æ¬¡æ”¶å·¥)
    if (lastAction === clockType) {
        alert("âš ï¸ éŒ¯èª¤ï¼šä½ æœ€å¾Œä¸€ç­†ç´€éŒ„å·²ç¶“ä¿‚ã€Œ" + lastAction + "ã€ï¼Œè«‹å…ˆæ‰“ã€Œ" + (clockType === "ç¿»å·¥" ? "æ”¶å·¥" : "ç¿»å·¥") + "ã€ï¼");
        input.value = "";
        return;
    }
    // --- ã€æª¢æŸ¥å®Œç•¢ã€‘ ---

    const loading = document.getElementById("loading");
    loading.innerHTML = "<b>ğŸ”’ æ­£åœ¨åŠ å¯†ä¸¦ä¸Šå‚³è³‡æ–™...</b>";
    loading.style.display = "flex";
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const maxW = 500;
            canvas.width = maxW;
            canvas.height = img.height * (maxW / img.width);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.4);
            const detail = selectedSchedule[4] + " [" + selectedSchedule[1] + "]";
            
            fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify({ action: "save", name: currentUser, location: selectedSchedule[3], type: clockType, detail: detail, image: dataUrl })
            }).then(r => r.json()).then(res => {
                document.getElementById("successType").innerText = clockType + "æˆåŠŸ";
                document.getElementById("successTime").innerText = res.time;
                document.getElementById("successDetail").innerHTML = `<b style="color:var(--primary); font-size:18px;">${selectedSchedule[3]}</b><br>${selectedSchedule[4]}`;
                window.showBox('successBox');
                loading.style.display = "none";
                
                // åˆ·æ–°æœ¬åœ°æ¨™è¨˜
                const timeStr = selectedSchedule[1] || "";
                const eventName = selectedSchedule[4] || "";
                const uniqueKey = eventName + " [" + timeStr + "]";
                
                // å°‡æ–°ç´€éŒ„ push å…¥ cachedDataï¼Œç¢ºä¿ä¸‹ä¸€æ›´æ‰“å¡æœƒå— Policy é™åˆ¶
                const d = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
                const d0 = String(d.getDate()).padStart(2, '0');
                const m0 = String(d.getMonth() + 1).padStart(2, '0');
                const dStr = `${d0}-${m0}-${d.getFullYear()}`;
                
                cachedData.records.push([dStr, currentUser, selectedSchedule[3], clockType, res.time, uniqueKey]);
                renderUI();
            });
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
};

window.startRecordFlow = () => {
    if(!cachedData || !cachedData.records || cachedData.records.length === 0) {
        alert("æš«ç„¡æ‰“å¡ç´€éŒ„"); return;
    }
    const locs = [...new Set(cachedData.records.map(r => r[2]))];
    let h = "";
    locs.forEach(l => h += `<div class="menu-btn" onclick="chooseRecordLoc('${l}')"><b>${l}</b><span>â¯</span></div>`);
    document.getElementById("listRecordLoc").innerHTML = h;
    window.showBox('recordLocBox');
};

window.chooseRecordLoc = (l) => {
    curRecordLoc = l;
    document.getElementById("titleRecordYM").innerText = l;
    const myRecords = cachedData.records.filter(r => r[2] === l);
    const ymSet = [...new Set(myRecords.map(r => {
        const p = parseDateStr(r[0]); return p[0] + "å¹´" + p[1] + "æœˆ";
    }))].sort().reverse();
    let h = "";
    ymSet.forEach(ym => h += `<div class="menu-btn" onclick="chooseRecordYM('${ym}')"><b>${ym}</b><span>â¯</span></div>`);
    document.getElementById("listRecordYM").innerHTML = h;
    window.showBox('recordMonthBox');
};

window.chooseRecordYM = (ym) => {
    const yNum = ym.split("å¹´")[0];
    const mNum = ym.split("å¹´")[1].replace("æœˆ","");
    document.getElementById("titleRecordFinal").innerText = curRecordLoc + " (" + ym + ")";
    const myRecords = cachedData.records.filter(r => {
        const p = parseDateStr(r[0]);
        return r[2] === curRecordLoc && p[0] === yNum && p[1] === mNum;
    });
    const dailyGroup = {};
    myRecords.forEach(r => {
        const dStr = r[0];
        if(!dailyGroup[dStr]) dailyGroup[dStr] = [];
        dailyGroup[dStr].push(r);
    });
    const sortedDates = Object.keys(dailyGroup).sort((a,b) => {
        const pA = parseDateStr(a); const pB = parseDateStr(b);
        return new Date(pB[0], pB[1]-1, pB[2]) - new Date(pA[0], pA[1]-1, pA[2]);
    });
    let h = "";
    sortedDates.forEach(dateStr => {
        const logs = dailyGroup[dateStr];
        h += `<div class="date-group">
            <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
                <span>ğŸ“… ${dateStr}</span><span style="font-size:12px; color:#999;">å±•é–‹ â–¼</span>
            </div>
            <div class="date-content">
                ${logs.map(log => {
                    const isOut = log[3] === "æ”¶å·¥";
                    const realTime = log[4].split(' ')[1] || log[4];
                    return `<div style="text-align:left; padding:12px 0; border-bottom:1px solid #f2f2f7;">
                        <div style="display:flex; align-items:center; margin-bottom:4px;">
                            <span class="tag ${isOut ? 'tag-out' : 'tag-in'}">${log[3]}</span>
                            <span style="font-weight:700; font-size:15px; margin-left:8px;">${realTime}</span>
                        </div>
                        <div style="padding-left:58px;"><small style="color:#8e8e93; font-size:12px;">${log[5]}</small></div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    });
    document.getElementById("listRecordFinal").innerHTML = h || "ç„¡è³‡æ–™";
    window.showBox('recordFinalBox');
};

window.submitSupport = () => {
    var msgElement = document.getElementById("supportMsg");
    var msg = msgElement.value.trim();
    if (!msg) return alert("è«‹è¼¸å…¥ç•™è¨€å…§å®¹");
    document.getElementById("loading").style.display = "flex";
    
    fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({ action: "support", name: currentUser, message: msg })
    }).then(() => {
        document.getElementById("loading").style.display = "none";
        alert("æ”¶åˆ°ä½ ï¼");
        msgElement.value = "";
        window.showBox('menuBox');
    });
};

function parseDateStr(s) {
    if (!s) return ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
    let str = s instanceof Date ? s.toLocaleDateString('zh-HK') : s.toString();
    let cleanStr = str.replace(/[/\sT]/g, "-");
    let parts = cleanStr.split("-");
    if (parts[0].length === 4) return [parts[0], parseInt(parts[1]).toString(), parseInt(parts[2]).toString()];
    if (parts[2] && parts[2].length === 4) return [parts[2], parseInt(parts[1]).toString(), parseInt(parts[0]).toString()];
    return ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
}
// --- è£œå›æ ¸å¿ƒåˆ‡æ›èˆ‡ç™»å…¥åŠŸèƒ½ ---
window.showBox = (id) => {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
};

window.doLogin = async () => {
    const name = document.getElementById("name").value.trim();
    const pin = document.getElementById("pin").value.trim();
    if (!name || !pin) return alert("è«‹è¼¸å…¥åç¨±åŠPIN");

    const loading = document.getElementById("loading");
    loading.style.display = "flex";

    try {
        const q = query(collection(db, "users"), where("name", "==", name), where("pin", "==", pin));
        const snap = await getDocs(q);
        if (snap.empty) {
            alert("ç™»å…¥å¤±æ•—ï¼šåç¨±æˆ–PINéŒ¯èª¤");
        } else {
            currentUser = name;
            document.getElementById("userHello").innerText = "ä½ å¥½, " + name;
            // æŠ“å–æ‰€æœ‰æ’ç­èˆ‡ç´€éŒ„
            const res = await fetch(WEB_APP_URL + "?name=" + encodeURIComponent(name));
            cachedData = await res.json();
            renderUI();
            showBox('menuBox');
        }
    } catch (e) {
        console.error(e);
        alert("ç™»å…¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡");
    }
    loading.style.display = "none";
};
</script>
</body>
</html>
