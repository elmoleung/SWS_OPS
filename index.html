<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SWS/OPSå“¡å·¥æ‰“å¡ç³»çµ±</title>
    <style>
        :root { --primary: #000; --bg: #f2f2f7; --success: #34c759; --blue: #007aff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin:0; font-family:-apple-system, 'SF Pro Display', sans-serif; background: var(--bg); color: #1c1c1e; }
        .card { background:white; width:92%; max-width:400px; padding:25px; border-radius:28px; box-shadow:0 10px 30px rgba(0,0,0,0.08); text-align:center; margin: 20px auto; display: none; }
        .active { display: block !important; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        h2 { margin-bottom:20px; font-size:22px; font-weight:700; }
        button { width:100%; padding:18px; border-radius:16px; border:none; background:var(--primary); color:white; font-size:16px; font-weight:600; margin-top:10px; cursor:pointer; }
        button:active { opacity: 0.7; transform: scale(0.98); }
        button:disabled { background: #ccc !important; }
        .secondary { background:#e5e5e7; color:#000; }
        .home-link { color: var(--blue); cursor: pointer; display: block; margin-top: 15px; font-size: 15px; font-weight: 600; text-decoration: none; }
        #btnIn { background: #FFFBCC; color: #856404; border: 1px solid #ffeeba; }
        #btnOut { background: #CCE5FF; color: #004085; border: 1px solid #b8daff; }
        .menu-btn { text-align:left; padding:18px; background:#fff; margin-bottom:12px; border-radius:18px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .record-item { text-align:left; padding:15px; border-bottom:1px solid #f2f2f7; font-size:14px; position: relative; }
        .tag { font-size:11px; padding:4px 10px; border-radius:8px; font-weight:800; display: inline-block; min-width: 50px; text-align: center; }
        .tag-in { background: #FFFBCC; color: #856404; border: 0.5px solid #ffeeba; }
        .tag-out { background: #CCE5FF; color: #004085; border: 0.5px solid #b8daff; }
        input, textarea { width:100%; padding:18px; margin-bottom:15px; border-radius:16px; border:1.5px solid #d1d1d6; font-size:16px; outline:none; }
        .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; backdrop-filter: blur(3px); }
        .big-check { font-size: 70px; margin-bottom: 10px; }
        .date-group { border: 1px solid #e5e5e7; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; }
        .date-header { background: #f9f9fb; padding: 15px; text-align: left; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .date-content { display: none; padding: 0 15px; background: #fff; border-top: 1px solid #eee; }
        .date-content.open { display: block; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay"><b>âŒ› è™•ç†ä¸­...</b></div>

<div class="card active" id="loginBox">
    <div style="font-size: 50px; margin-bottom: 15px;">ğŸ’¼</div>
    <h2>SWS/OPS æ‰“å¡ç³»çµ±</h2>
    <input id="name" placeholder="ç™»å…¥åç¨±" autocomplete="off">
    <input id="pin" type="password" placeholder="PINç¢¼" inputmode="numeric">
    <button id="loginBtn" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
</div>

<div class="card" id="menuBox">
    <h2 id="userHello">ä½ å¥½</h2>
    <div class="menu-btn" onclick="showBox('clockInBox')"><div>ğŸ“ <b>æˆ‘è¦æ‰“å¡ï¼</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="startSchedFlow()"><div>ğŸ“… <b>æˆ‘æƒ³ç‡æ›´ï¼</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="startRecordFlow()"><div>ğŸ“œ <b>æ‰“å¡ç´€éŒ„</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="showBox('supportBox')"><div>ğŸ› ï¸ <b>æŠ€è¡“æ”¯æ´</b></div><span>â¯</span></div>
    <button id="refreshDataBtn" class="secondary" onclick="doRefreshData()" style="margin-top:20px; background:#e1f5fe; color:#01579b;">ğŸ”„ æ›´æ–°æœ€æ–°è³‡æ–™</button>
    <button class="secondary" onclick="doLogout()" style="margin-top:10px;">ç™»å‡ºç³»çµ±</button>
</div>

<div class="card" id="clockInBox">
    <h2>æœ€è¿‘ä¸‰æ—¥(æ˜¨/ä»Š/æ˜)æ›´æ¬¡</h2>
    <div id="todaySchedules"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<div class="card" id="typeBox">
    <h2 id="selectedJobTitle">åœ°é»</h2>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleCapture(this)" style="display:none">
    <button id="btnIn" onclick="triggerCamera('ç¿»å·¥')">ğŸŒ… ç¿»å·¥æ‰“å¡</button>
    <button id="btnOut" onclick="triggerCamera('æ”¶å·¥')">ğŸŒ‡ æ”¶å·¥æ‰“å¡</button>
    <button class="secondary" onclick="showBox('clockInBox')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="successBox">
    <div class="big-check">âœ…</div>
    <h2 id="successType">æ‰“å¡æˆåŠŸ</h2>
    <p id="successTime" style="font-size:20px; font-weight:bold; margin:10px 0;"></p>
    <p id="successDetail" style="color:#666; font-size:14px;"></p>
    <button onclick="showBox('menuBox')">è¿”å›ä¸»é </button>
</div>

<div class="card" id="boxLoc">
    <h2>é¸æ“‡åœ°é»</h2>
    <div id="listLoc"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<div class="card" id="boxYM">
    <h2 id="titleYM">é¸æ“‡å¹´ä»½</h2>
    <div id="listYM"></div>
    <button class="secondary" onclick="showBox('boxLoc')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="boxFinal">
    <h2 id="titleFinal">é¸æ“‡æ˜ŸæœŸ</h2>
    <div id="listFinal" style="max-height:400px; overflow-y:auto;"></div>
    <button class="secondary" onclick="showBox('boxYM')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="recordLocBox">
    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ¢</div>
    <h2>é¸æ“‡ç´€éŒ„åœ°é»</h2>
    <div id="listRecordLoc"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›ä¸»é </button>
</div>

<div class="card" id="recordMonthBox">
    <h2 id="titleRecordYM">é¸æ“‡æœˆä»½</h2>
    <div id="listRecordYM"></div>
    <button class="secondary" onclick="showBox('recordLocBox')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="recordFinalBox">
    <h2 id="titleRecordFinal">æ›´è¡¨è©³æƒ…</h2>
    <div id="listRecordFinal" style="max-height:450px; overflow-y:auto; padding:5px;"></div>
    
    <button class="secondary" onclick="showBox('boxFinal')">è¿”å›æ˜ŸæœŸåˆ—è¡¨</button>
    <button class="secondary" onclick="showBox('menuBox')" style="margin-top:10px;">è¿”å›ä¸»é </button>
</div>

<div class="card" id="supportBox">
    <h2>æŠ€è¡“æ”¯æ´</h2>
    <p style="font-size: 14px; color: #ff3b30; font-weight: bold; margin-bottom: 15px;">âš ï¸ æœ‰ç·Šæ€¥äº‹è«‹è‡ªè¡Œè¯çµ¡Elmo</p>
    <textarea id="supportMsg" rows="4" placeholder="è«‹è¼¸å…¥ç•™è¨€..."></textarea>
    <button id="supportBtn" onclick="submitSupport()">æäº¤ç•™è¨€</button>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDTT86mpGJJMByToRMi7b8jjI0LoNJarNo",
    authDomain: "sws-ops.firebaseapp.com",
    projectId: "sws-ops",
    storageBucket: "sws-ops.firebasestorage.app",
    messagingSenderId: "985280948590",
    appId: "1:985280948590:web:3aad1539136659b4dc797f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwX_YbC2RS7p_ItXOaFmgHSKFa4_ZeTtdbnQchPvYJeOWshDieF1PahIKLaHy26QUDvbg/exec";
let currentUser = "";
let cachedData = null;
let curL = "";
let curRecordLoc = "";
let selectedSchedule = null;
let clockType = "";

function parseDateStr(s) {
    if (!s) return ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
    let str = String(s).trim();
    
    // å…ˆè™•ç†å¸¸è¦‹åˆ†éš”ç¬¦ï¼Œçµ±ä¸€è®Šåš "-"
    let cleanStr = str.replace(/\//g, "-").replace(/\./g, "-");
    
    // å¦‚æœå…¥é¢æœ‰ç©ºæ ¼ï¼ˆä¾‹å¦‚ 01-03-2026 00:00:00ï¼‰ï¼Œåªæ”å‰é¢æ—¥æœŸéƒ¨åˆ†
    cleanStr = cleanStr.split(" ")[0];
    
    let parts = cleanStr.split("-");

    let y, m, d;

    if (parts.length === 3) {
        // æƒ…æ³ B (ä½ é¸ç”¨çš„æ ¼å¼): DD-MM-YYYY (ä¾‹å¦‚ 01-03-2026)
        // åˆ¤æ–·æœ€å¾Œä¸€æˆªä¿‚å’ªå¹´ä»½ (4ä½æ•¸)
        if (parts[2].length === 4) {
            y = parts[2];
            m = parseInt(parts[1]).toString(); // 03 è®Š 3
            d = parseInt(parts[0]).toString(); // 01 è®Š 1
        } 
        // æƒ…æ³ A (å¾Œå‚™): YYYY-MM-DD (ä¾‹å¦‚ 2026-03-01)
        else if (parts[0].length === 4) {
            y = parts[0];
            m = parseInt(parts[1]).toString();
            d = parseInt(parts[2]).toString();
        }
    }

    // æœ€å¾Œæª¢æŸ¥ä¿‚å’ªçœŸä¿‚æ”åˆ°æ•¸å­—ï¼Œæ”å””åˆ°å°±å›å‚³æœªçŸ¥
    if (y && !isNaN(m) && !isNaN(d)) return [y, m, d];
    return ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
}
// æ ¸å¿ƒ Helper: å–å¾—é¦™æ¸¯ä»Šæ—¥æ—¥æœŸæ ¼å¼
const getHKTodayFormats = () => {
    const d = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
    const d0 = String(d.getDate()).padStart(2, '0');
    const m0 = String(d.getMonth() + 1).padStart(2, '0');
    const y = d.getFullYear();
    return [`${d.getDate()}-${d.getMonth()+1}-${y}`, `${d0}-${m0}-${y}`, `${d.getDate()}/${d.getMonth()+1}/${y}`, `${d0}/${m0}/${y}`];
};

window.showBox = (id) => {
    const cards = document.getElementsByClassName('card');
    for(let i=0; i<cards.length; i++) cards[i].classList.remove('active');
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
};

window.doLogin = async () => {
    const n = document.getElementById("name").value.trim();
    const p = document.getElementById("pin").value.trim();
    if(!n || !p) return;
    
    const btn = document.getElementById("loginBtn");
    const loading = document.getElementById("loading");
    btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;
    loading.style.display = "flex";

    try {
        const q = query(collection(db, "employees"), where("name", "==", n), where("pin", "==", p));
        const snap = await getDocs(q);
        if(!snap.empty) {
            const response = await fetch(`${WEB_APP_URL}?action=refresh&name=${encodeURIComponent(n)}`);
            cachedData = await response.json();
            currentUser = n;
            localStorage.setItem("sws_user", n);
            localStorage.setItem("sws_pin", p);
            window.renderUI();
            document.getElementById("userHello").innerText = "ä½ å¥½ï¼Œ" + currentUser;
            window.showBox('menuBox');
        } else {
            alert("âŒ ç™»å…¥å¤±æ•—");
        }
    } catch(e) { alert("é€£ç·šå¤±æ•—: " + e.message); }
    btn.innerText = "ç™»å…¥ç³»çµ±"; btn.disabled = false;
    loading.style.display = "none";
};
window.doRefreshData = async () => {
    const btn = document.getElementById("refreshDataBtn");
    const loading = document.getElementById("loading");
    
    // 1. é¡¯ç¤º Loading ç‹€æ…‹
    btn.innerText = "æ›´æ–°ä¸­...";
    btn.disabled = true;
    loading.style.display = "flex";

    try {
        // 2. å‘ GAS é‡æ–°æ”ä¸€æ¬¡è³‡æ–™ (ç”¨è¿”è€Œå®¶å€‹ currentUser)
        const response = await fetch(`${WEB_APP_URL}?action=refresh&name=${encodeURIComponent(currentUser)}`);
        const newData = await response.json();
        
        // 3. æ›´æ–°æš«å­˜è®Šæ•¸ä¸¦é‡æ–°ç•« UI
        cachedData = newData;
        window.renderUI(); 
        
        alert("âœ… è³‡æ–™å·²åŒæ­¥è‡³æœ€æ–°ç‹€æ…‹ï¼");
    } catch(e) {
        alert("âŒ æ›´æ–°å¤±æ•—: " + e.message);
    } finally {
        // 4. æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        btn.innerText = "ğŸ”„ æ›´æ–°æœ€æ–°è³‡æ–™";
        btn.disabled = false;
        loading.style.display = "none";
    }
};
window.doLogout = () => {
    // å‘¢å…©è¡Œä¿‚å°‡é ­å…ˆå„²å­˜å’—å˜…ååŒ PIN æŠ¹èµ°
    localStorage.removeItem("sws_user");
    localStorage.removeItem("sws_pin");
    // ç„¶å¾Œé‡æ–°æ•´ç†ç¶²é ï¼Œå’æ¨£å°±æœƒè®Šè¿”ä¸€å€‹ã€Œä¹¾æ·¨ã€å˜…ç™»å…¥ç•«é¢
    location.reload();
};
window.renderUI = () => {
    let h = "";
    const hkt = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
    const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];

    const getDateInfo = (d) => {
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const y = d.getFullYear();
        const dayName = dayNames[d.getDay()];
        return {
            display: `${dd}-${mm}-${y} (${dayName})`,
            version1: `${dd}-${mm}-${y}`
        };
    };

    const dateGroups = [
        { label: "æ˜¨æ—¥", info: getDateInfo(new Date(new Date(hkt).setDate(hkt.getDate() - 1))) },
        { label: "ä»Šæ—¥", info: getDateInfo(hkt) },
        { label: "ç¿Œæ—¥", info: getDateInfo(new Date(new Date(hkt).setDate(hkt.getDate() + 1))) }
    ];

    dateGroups.forEach(group => {
        const dayScheds = (cachedData.allSchedules || []).filter(s => {
            const sDateParts = parseDateStr(s[0]);
            const sDateFormatted = `${sDateParts[0]}-${sDateParts[1].padStart(2,'0')}-${sDateParts[2].padStart(2,'0')}`;
            const gParts = group.info.version1.split('-'); 
            const gDateFormatted = `${gParts[2]}-${gParts[1]}-${gParts[0]}`;
            return sDateFormatted === gDateFormatted;
        });
        
        h += `<div class="date-group">
            <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
                <span>ğŸ“… <b>${group.label}</b> (${group.info.display})</span><span>â–¼</span>
            </div>
            <div class="date-content ${group.label === 'ä»Šæ—¥' ? 'open' : ''}">`;
        
        if (dayScheds.length === 0) {
            h += `<p style="color:#999; padding:15px; text-align:center;">ç„¡å®‰æ’æ›´æ¬¡</p>`;
        } else {
            dayScheds.sort((a, b) => a[1].localeCompare(b[1]));
            
            dayScheds.forEach(s => {
                const uKey = (s[4] || "").trim(); 
                
                // å¿…é ˆè¦æœ‰å‘¢æ®µï¼Œå¦å‰‡ç³»çµ±å””çŸ¥é‚Šå€‹æ›´æ¬¡ã€Œå·²å®Œæ›´ã€
                const hasOut = (cachedData.records || []).some(r => {
                    const rp = parseDateStr(r[0]), sp = parseDateStr(s[0]);
                    const dateMatch = `${rp[0]}-${rp[1]}-${rp[2]}` === `${sp[0]}-${sp[1]}-${sp[2]}`;
                    const keyMatch = (r[5] || "").trim() === uKey;
                    return dateMatch && keyMatch && r[3] === "æ”¶å·¥";
                });

                const sParam = JSON.stringify(s).replace(/"/g, '&quot;');
                h += `<div class="menu-btn" style="${hasOut ? 'opacity:0.6; pointer-events:none;' : ''}; display: flex; align-items: center; justify-content: space-between; padding: 15px;" onclick='window.selectJobFromList(${sParam})'>
                    <div style="flex: 1; text-align: left;">
                        <b style="font-size: 1.1em; display: block; margin-bottom: 4px; color: #1c1c1e;">${s[3]}</b>
                        <small style="color: #666; font-size: 0.9em; display: block; margin-bottom: 2px;">â° ${s[1]}</small>
                        <small style="color: #444; font-size: 0.9em; display: block;">ğŸ”– ${s[4] || "ä¸€èˆ¬å‹¤å‹™"}</small>
                    </div>
                    <div style="margin-left: 12px; white-space: nowrap;">
                        <span style="color: var(--blue); font-weight: bold; font-size: 0.9em;">
                            ${hasOut ? "âœ… å·²å®Œæ›´" : "â¯"}
                        </span>
                    </div>
                </div>`;
            });
        }
        h += `</div></div>`;
    });
    document.getElementById("todaySchedules").innerHTML = h;
};

window.selectJobFromList = (s) => {
    selectedSchedule = s;
    const uKey = (s[4] || "").trim();
    const sp = parseDateStr(s[0]);
    const sDateStr = `${sp[0]}-${sp[1]}-${sp[2]}`;

    // æª¢æŸ¥ç¿»å·¥åŒæ”¶å·¥ç‹€æ…‹
    const records = cachedData.records || [];
    const hasIn = records.some(r => {
        const rp = parseDateStr(r[0]);
        const rKey = (r[5] || "").trim();
        return `${rp[0]}-${rp[1]}-${rp[2]}` === sDateStr && rKey === uKey && r[3] === "ç¿»å·¥";
    });

    const hasOut = records.some(r => {
        const rp = parseDateStr(r[0]);
        const rKey = (r[5] || "").trim();
        return `${rp[0]}-${rp[1]}-${rp[2]}` === sDateStr && rKey === uKey && r[3] === "æ”¶å·¥";
    });

    document.getElementById("selectedJobTitle").innerText = s[3];
    const bIn = document.getElementById("btnIn");
    const bOut = document.getElementById("btnOut");
    
    bIn.disabled = hasIn; 
    bIn.innerText = hasIn ? "âœ… å·²å®Œæˆç¿»å·¥" : "ğŸŒ… ç¿»å·¥æ‰“å¡"; 
    bIn.style.opacity = hasIn ? "0.5" : "1";
    
    bOut.disabled = hasOut; 
    bOut.innerText = hasOut ? "âœ… å·²å®Œæˆæ”¶å·¥" : "ğŸŒ‡ æ”¶å·¥æ‰“å¡"; 
    bOut.style.opacity = hasOut ? "0.5" : "1";
    
    window.showBox('typeBox');
};

window.triggerCamera = (t) => {
    clockType = t;
    document.getElementById("cameraInput").click();
};

window.handleCapture = (input) => {
    if (!input.files[0]) return;
    const loading = document.getElementById("loading");
    loading.style.display = "flex";
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement("canvas");
            const maxW = 500;
            canvas.width = maxW;
            canvas.height = img.height * (maxW / img.width);
            canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
            
            const detail = (selectedSchedule[4] || "").trim(); 
            
            fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify({ 
                    action: "save", 
                    name: currentUser, 
                    location: selectedSchedule[3], 
                    type: clockType, 
                    detail: detail, 
                    image: canvas.toDataURL("image/jpeg", 0.4) 
                })
            })
            .then(r => r.json()).then(res => {
                document.getElementById("successType").innerText = clockType + "æˆåŠŸ";
                document.getElementById("successTime").innerText = res.time;
                document.getElementById("successDetail").innerText = selectedSchedule[3];
                
                // ç¢ºä¿ records å­˜åœ¨ä¸¦æ›´æ–°
                if (!cachedData.records) cachedData.records = [];
                cachedData.records.push([
                    selectedSchedule[0], 
                    currentUser,
                    selectedSchedule[3], 
                    clockType,  
                    res.time,
                    detail
                ]);
                
                window.renderUI(); // å‘¢å¥æœ€é‡è¦ï¼šæ‰“å®Œå¡å³æ™‚è®Šç°é–æ£
                window.showBox('successBox');
                loading.style.display = "none";
            }).catch(err => {
                alert("å‚³è¼¸å¤±æ•—ï¼š" + err);
                loading.style.display = "none";
            });
        }; 
        img.src = e.target.result;
    }; 
    reader.readAsDataURL(input.files[0]);
};

window.startSchedFlow = () => {
    const locs = [...new Set(cachedData.allSchedules.map(s => s[3]))];
    let h = "";
    locs.forEach(l => h += `<div class="menu-btn" onclick="chooseLoc('${l}')"><b>${l}</b><span>â¯</span></div>`);
    document.getElementById("listLoc").innerHTML = h;
    window.showBox('boxLoc');
};

window.startRecordFlow = () => {
    const locs = [...new Set((cachedData.records || []).map(r => r[2]))];
    let h = "";
    locs.forEach(l => h += `<div class="menu-btn" onclick="chooseRecordLoc('${l}')"><b>${l}</b><span>â¯</span></div>`);
    document.getElementById("listRecordLoc").innerHTML = h;
    window.showBox('recordLocBox');
};

window.chooseLoc = (l) => {
    curL = l;
    // åªæå–å¹´ä»½ (ä¾‹å¦‚ 2026å¹´)
    const yearSet = [...new Set(cachedData.allSchedules.filter(s => s[3] === l).map(s => {
        const p = parseDateStr(s[0]); 
        return p[0] + "å¹´";
    }))].sort().reverse();
    
    let h = "";
    yearSet.forEach(y => {
        // æ’³å®Œå¹´ä»½æœƒå» chooseYear
        h += `<div class="menu-btn" onclick="chooseYear('${y}')"><b>${y}</b><span>â¯</span></div>`;
    });
    document.getElementById("listYM").innerHTML = h;
    document.getElementById("titleYM").innerText = l; // é¡¯ç¤ºåœ°é»å
    window.showBox('boxYM');
};

window.chooseYear = (yText) => {
    const targetYear = yText.replace("å¹´", "");
    const schedules = cachedData.allSchedules.filter(s => {
        const p = parseDateStr(s[0]); 
        return s[3] === curL && p[0] === targetYear;
    });

    const weeks = {};
    schedules.forEach(s => {
        const p = parseDateStr(s[0]);
        const d = new Date(p[0], p[1]-1, p[2]);
        const day = d.getDay(); 
        const diff = d.getDate() - (day === 0 ? 6 : day - 1); 
        const monday = new Date(new Date(d).setDate(diff));
        const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
        const weekStr = `${monday.getDate()}/${monday.getMonth()+1} - ${sunday.getDate()}/${sunday.getMonth()+1}`;
        if (!weeks[weekStr]) weeks[weekStr] = [];
        weeks[weekStr].push(s);
    });

    // å°‡æ˜ŸæœŸç”±æ–°åˆ°èˆŠæ’ (æœ€è¿‘æœŸå˜…ç¦®æ‹œæ“ºæœ€é ‚)
    const sortedWeeks = Object.keys(weeks).sort((a, b) => {
        const dateA = parseInt(a.split('/')[0]);
        const dateB = parseInt(b.split('/')[0]);
        return dateB - dateA;
    });

    let h = "";
    sortedWeeks.forEach(w => {
        h += `<div class="menu-btn" onclick="showWeeklyDetail('${w}', '${targetYear}')"><b>${w}</b><span>â¯</span></div>`;
    });
    
    document.getElementById("listFinal").innerHTML = h;
    document.getElementById("titleFinal").innerText = "é¸æ“‡æ˜ŸæœŸ";
    window.showBox('boxFinal');
};

window.showWeeklyDetail = (weekRange, year) => {
    // å‘¢åº¦ filter é‚è¼¯ç¶­æŒåŸæ¨£ (æ ¹æ“š weekRange æµæ›´)
    const schedules = cachedData.allSchedules.filter(s => {
        const p = parseDateStr(s[0]);
        const d = new Date(p[0], p[1]-1, p[2]);
        const day = d.getDay();
        const diff = d.getDate() - (day === 0 ? 6 : day - 1); 
        const mon = new Date(new Date(d).setDate(diff));
        const sun = new Date(new Date(mon).setDate(mon.getDate() + 6));
        const range = `${mon.getDate()}/${mon.getMonth()+1} - ${sun.getDate()}/${sun.getMonth()+1}`;
        return s[3] === curL && p[0] === year && range === weekRange;
    });

    const days = {};
    const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
    
    schedules.forEach(s => {
        if (!days[s[0]]) days[s[0]] = [];
        days[s[0]].push(s);
    });

    let h = "";
    const sortedDates = Object.keys(days).sort((a, b) => {
        const pa = parseDateStr(a), pb = parseDateStr(b);
        return new Date(pa[0], pa[1]-1, pa[2]) - new Date(pb[0], pb[1]-1, pb[2]);
    });

    sortedDates.forEach(date => {
        const p = parseDateStr(date);
        const d = new Date(p[0], p[1]-1, p[2]);
        const dayName = dayNames[d.getDay()];

        // å‘¢åº¦æ”¹å’—ï¼šé¡¯ç¤ºåšè£œé›¶ç‰ˆæœ¬ 28-02-2026
        const dd = String(p[2]).padStart(2, '0');
        const mm = String(p[1]).padStart(2, '0');
        const displayDate = `${dd}-${mm}-${p[0]} (${dayName})`;

        h += `<div class="date-group">
            <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
                <span>ğŸ“… <b>${displayDate}</b></span><span>â–¼</span>
            </div>
            <div class="date-content">`;
        
        // æ’åºï¼šç¢ºä¿åŒä¸€æ—¥å…¥é¢å˜…æ›´æ¬¡éƒ½ä¿‚ç”±æ—©åˆ°é²æ’
        days[date].sort((a, b) => a[1].localeCompare(b[1]));

        days[date].forEach(s => {
            h += `<div class="record-item" style="padding:12px 15px;">
                <div style="font-weight:bold; font-size:1.1em; margin-bottom:4px;">â° ${s[1]}</div>
                <div style="color:#333; font-size:1em;"> ${s[4]}</div>
            </div>`;
        });
        h += `</div></div>`;
    });

    document.getElementById("listRecordFinal").innerHTML = h || "è©²æ˜ŸæœŸç„¡è³‡æ–™";
    document.getElementById("titleRecordFinal").innerText = weekRange;
    window.showBox('recordFinalBox');
};

window.chooseRecordLoc = (l) => {
    window.curRecordLoc = l;
    
    // 1. æµå‡ºæ‰€æœ‰å¹´æœˆ (2026å¹´2æœˆ, 2026å¹´1æœˆ...)
    const records = cachedData.records || [];
    const ymSet = [...new Set(records.filter(r => r[2] === l).map(r => {
        const p = parseDateStr(r[0]); 
        return p[0] + "å¹´" + p[1] + "æœˆ";
    }))].sort().reverse();

    // 2. ç”¢ç”Ÿã€Œä¸‹æ‹‰è³‡æ–™å¤¾ã€æ¨™é¡Œ
    let h = ymSet.map(ym => {
        const safeId = ym.replace(/[å¹´æœˆ]/g, "-");
        return `
            <div class="date-group" style="margin-bottom:12px; border:1px solid #ddd; border-radius:8px; overflow:hidden;">
                <div class="date-header" onclick="window.chooseRecordYM('${ym}', '${safeId}')" style="background:#f9f9f9; padding:15px; display:flex; justify-content:space-between; cursor:pointer; font-weight:bold; align-items:center;">
                    <span>ğŸ“‚ ${ym}</span>
                    <span id="arrow-${safeId}">â–¼</span>
                </div>
                <div id="box-${safeId}" style="display:none; background:#fff; border-top:1px solid #eee;">
                    <p style="text-align:center; padding:15px; color:#999;">è¼‰å…¥ç´€éŒ„ä¸­...</p>
                </div>
            </div>
        `;
    }).join('');

    // 3. æµè¿” listRecordYM å‘¢å€‹å®¹å™¨
    const container = document.getElementById("listRecordYM");
    if (container) {
        container.innerHTML = h || "<p style='text-align:center; padding:20px;'>æ­¤åœ°é»æš«ç„¡ç´€éŒ„</p>";
        window.showBox('recordMonthBox');
    }
};

window.chooseRecordYM = (ym, safeId) => {
    const contentEl = document.getElementById("box-" + safeId);
    if (!contentEl) return;
    
    // åŸåœ°é–‹åˆ
    if (contentEl.style.display === 'block') {
        contentEl.style.display = 'none';
        document.getElementById("arrow-" + safeId).innerText = "â–¼";
        return;
    }

    const [y, m] = [ym.split("å¹´")[0], ym.split("å¹´")[1].replace("æœˆ","")];
    const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];

    // 1. éæ¿¾ç´€éŒ„ (å¹´ä»½åŒæœˆä»½è¦å°ä¸­)
    const logs = (cachedData.records || []).filter(r => {
        const p = parseDateStr(r[0]); 
        return r[2] === window.curRecordLoc && p[0] === y && String(p[1]) === String(m);
    });

    // 2. æ’åº (ç”±æ–°åˆ°èˆŠ)
    logs.sort((a, b) => {
        const pa = parseDateStr(a[0]), pb = parseDateStr(b[0]);
        return new Date(pb[0], pb[1]-1, pb[2]) - new Date(pa[0], pa[1]-1, pa[2]);
    });

    let h = "";
    let lastDate = "";

    logs.forEach(log => {
        const p = parseDateStr(log[0]);
        const displayDate = `${String(p[2]).padStart(2, '0')}-${String(p[1]).padStart(2, '0')}-${p[0]}`;
        const d = new Date(p[0], parseInt(p[1])-1, parseInt(p[2]));
        const dateHeader = `ğŸ“… ${displayDate} (${dayNames[d.getDay()]})`;

        if (displayDate !== lastDate) {
            h += `<div style="background:#f2f2f2; padding:8px 15px; font-weight:bold; color:#333; border-left:4px solid #007bff; margin-top:15px; text-align:left;">${dateHeader}</div>`;
            lastDate = displayDate;
        }

        // æ£èµ° Event åå…¥é¢å˜…æ™‚é–“æ‹¬è™Ÿ
        let cleanEvent = (log[5] || "").replace(/[\[\(].*?\d{1,2}:\d{2}.*?[\]\)]/g, "").trim();

        h += `
        <div style="padding:15px; border-bottom:1px solid #eee; text-align:left; background:#fff;">
            <div style="margin-bottom:6px; display:flex; align-items:center; gap:8px;">
                <span class="tag ${log[3]==='æ”¶å·¥'?'tag-out':'tag-in'}">${log[3]}</span> 
                <span style="color:#666; font-size:0.9em;">${displayDate}</span>
            </div>
            
            <div style="font-size:1.15em; font-weight:bold; color:#222; margin-bottom:4px;">
                æ‰“å¡æ™‚é–“ âœ… ${log[4]}
            </div>

            <div style="color:#007bff; font-size:0.9em; margin-bottom:2px;">
                ğŸ“ ${log[2]}
            </div>

            <div style="color:#444; font-size:0.95em; font-weight:500;">
                ğŸ”– ${cleanEvent || "ä¸€èˆ¬å‹¤å‹™"}
            </div>
        </div>`;
    });
    contentEl.innerHTML = h || "<p style='padding:20px; text-align:center;'>ç„¡ç´€éŒ„</p>";
    contentEl.style.display = 'block';
    document.getElementById("arrow-" + safeId).innerText = "â–²";
};
window.submitSupport = () => {
    const msg = document.getElementById("supportMsg").value.trim();
    if(!msg) return;
    fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "support", name: currentUser, message: msg }) })
    .then(() => { alert("æ”¶åˆ°ä½ ğŸ«¡"); window.showBox('menuBox'); });
};
// è‡ªå‹•æª¢æŸ¥ï¼šä»¤ Refresh æˆ–é‡æ–°é–‹ App å””ä½¿å†æ‰“å
const savedName = localStorage.getItem("sws_user");
const savedPin = localStorage.getItem("sws_pin");

if (savedName && savedPin) {
    document.getElementById("name").value = savedName;
    document.getElementById("pin").value = savedPin;
    window.doLogin(); // è‡ªå‹•åŸ·è¡Œç™»å…¥æµç¨‹
}
</script>
</body>
</html>
