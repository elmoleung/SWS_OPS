<!DOCTYPE html>
<html>
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>SWS/OPSå“¡å·¥æ‰“å¡ç³»çµ±</title>
Â  Â  <style>
Â  Â  Â  Â  :root { --primary: #000; --bg: #f2f2f7; --success: #34c759; --blue: #007aff; }
Â  Â  Â  Â  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
Â  Â  Â  Â  body { margin:0; font-family:-apple-system, 'SF Pro Display', sans-serif; background: var(--bg); color: #1c1c1e; }
Â  Â  Â  Â  .card { background:white; width:92%; max-width:400px; padding:25px; border-radius:28px; box-shadow:0 10px 30px rgba(0,0,0,0.08); text-align:center; margin: 20px auto; display: none; }
Â  Â  Â  Â  .active { display: block !important; animation: fadeIn 0.2s ease-out; }
Â  Â  Â  Â  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
Â  Â  Â  Â  h2 { margin-bottom:20px; font-size:22px; font-weight:700; }
Â  Â  Â  Â  button { width:100%; padding:18px; border-radius:16px; border:none; background:var(--primary); color:white; font-size:16px; font-weight:600; margin-top:10px; cursor:pointer; }
Â  Â  Â  Â  button:active { opacity: 0.7; transform: scale(0.98); }
Â  Â  Â  Â  button:disabled { background: #ccc !important; }
Â  Â  Â  Â  .secondary { background:#e5e5e7; color:#000; }
Â  Â  Â  Â  .home-link { color: var(--blue); cursor: pointer; display: block; margin-top: 15px; font-size: 15px; font-weight: 600; text-decoration: none; }
Â  Â  Â  Â  #btnIn { background: #FFFBCC; color: #856404; border: 1px solid #ffeeba; }
Â  Â  Â  Â  #btnOut { background: #CCE5FF; color: #004085; border: 1px solid #b8daff; }
Â  Â  Â  Â  .menu-btn { text-align:left; padding:18px; background:#fff; margin-bottom:12px; border-radius:18px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
Â  Â  Â  Â  .record-item { text-align:left; padding:15px; border-bottom:1px solid #f2f2f7; font-size:14px; position: relative; }
Â  Â  Â  Â  .tag { font-size:11px; padding:4px 10px; border-radius:8px; font-weight:800; display: inline-block; min-width: 50px; text-align: center; }
Â  Â  Â  Â  .tag-in { background: #FFFBCC; color: #856404; border: 0.5px solid #ffeeba; }
Â  Â  Â  Â  .tag-out { background: #CCE5FF; color: #004085; border: 0.5px solid #b8daff; }
Â  Â  Â  Â  input, textarea { width:100%; padding:18px; margin-bottom:15px; border-radius:16px; border:1.5px solid #d1d1d6; font-size:16px; outline:none; }
Â  Â  Â  Â  .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; backdrop-filter: blur(3px); }
Â  Â  Â  Â  .big-check { font-size: 70px; margin-bottom: 10px; }
Â  Â  Â  Â  .date-group { border: 1px solid #e5e5e7; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; }
Â  Â  Â  Â  .date-header { background: #f9f9fb; padding: 15px; text-align: left; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
Â  Â  Â  Â  .date-content { display: none; padding: 0 15px; background: #fff; border-top: 1px solid #eee; }
Â  Â  Â  Â  .date-content.open { display: block; }
Â  Â  </style>
</head>
<body>

<div id="loading" class="loading-overlay"><b>âŒ› è™•ç†ä¸­...</b></div>

<div class="card active" id="loginBox">
Â  Â  <div style="font-size: 50px; margin-bottom: 15px;">ğŸ’¼</div>
Â  Â  <h2>SWS/OPS æ‰“å¡ç³»çµ±</h2>
Â  Â  <input id="name" placeholder="ç™»å…¥åç¨±" autocomplete="off">
Â  Â  <input id="pin" type="password" placeholder="PINç¢¼" inputmode="numeric">
Â  Â  <button id="loginBtn" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
</div>

<div class="card" id="menuBox">
Â  Â  <h2 id="userHello">ä½ å¥½</h2>
Â  Â  <div class="menu-btn" onclick="showBox('clockInBox')"><div>ğŸ“ <b>æˆ‘è¦æ‰“å¡ï¼</b></div><span>â¯</span></div>
Â  Â  <div class="menu-btn" onclick="startSchedFlow()"><div>ğŸ“… <b>æˆ‘æƒ³ç‡æ›´ï¼</b></div><span>â¯</span></div>
Â  Â  <div class="menu-btn" onclick="startRecordFlow()"><div>ğŸ“œ <b>æ‰“å¡ç´€éŒ„</b></div><span>â¯</span></div>
Â  Â  <div class="menu-btn" onclick="showBox('supportBox')"><div>ğŸ› ï¸ <b>æŠ€è¡“æ”¯æ´</b></div><span>â¯</span></div>
Â  Â  <button class="secondary" onclick="location.reload()" style="margin-top:20px;">ç™»å‡ºç³»çµ±</button>
</div>

<div class="card" id="clockInBox">
Â  Â  <h2>æœ€è¿‘ä¸‰æ—¥(æ˜¨/ä»Š/æ˜)æ›´æ¬¡</h2>
Â  Â  <div id="todaySchedules"></div>
Â  Â  <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<div class="card" id="typeBox">
Â  Â  <h2 id="selectedJobTitle">åœ°é»</h2>
Â  Â  <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleCapture(this)" style="display:none">
Â  Â  <button id="btnIn" onclick="triggerCamera('ç¿»å·¥')">ğŸŒ… ç¿»å·¥æ‰“å¡</button>
Â  Â  <button id="btnOut" onclick="triggerCamera('æ”¶å·¥')">ğŸŒ‡ æ”¶å·¥æ‰“å¡</button>
Â  Â  <button class="secondary" onclick="showBox('clockInBox')">è¿”å›</button>
Â  Â  <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="successBox">
Â  Â  <div class="big-check">âœ…</div>
Â  Â  <h2 id="successType">æ‰“å¡æˆåŠŸ</h2>
Â  Â  <p id="successTime" style="font-size:20px; font-weight:bold; margin:10px 0;"></p>
Â  Â  <p id="successDetail" style="color:#666; font-size:14px;"></p>
Â  Â  <button onclick="showBox('menuBox')">è¿”å›ä¸»é </button>
</div>

<div class="card" id="boxLoc">
Â  Â  <h2>é¸æ“‡åœ°é»</h2>
Â  Â  <div id="listLoc"></div>
Â  Â  <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<div class="card" id="boxYM">
Â  Â  <h2 id="titleYM">é¸æ“‡å¹´ä»½</h2>
Â  Â  <div id="listYM"></div>
Â  Â  <button class="secondary" onclick="showBox('boxLoc')">è¿”å›</button>
Â  Â  <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="boxFinal">
Â  Â  <h2 id="titleFinal">é¸æ“‡æ˜ŸæœŸ</h2>
Â  Â  <div id="listFinal" style="max-height:400px; overflow-y:auto;"></div>
Â  Â  <button class="secondary" onclick="showBox('boxYM')">è¿”å›</button>
Â  Â  <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="recordLocBox">
Â  Â  <div style="font-size: 40px; margin-bottom: 10px;">ğŸ¢</div>
Â  Â  <h2>é¸æ“‡ç´€éŒ„åœ°é»</h2>
Â  Â  <div id="listRecordLoc"></div>
Â  Â  <button class="secondary" onclick="showBox('menuBox')">è¿”å›ä¸»é </button>
</div>

<div class="card" id="recordMonthBox">
Â  Â  <h2 id="titleRecordYM">é¸æ“‡æœˆä»½</h2>
Â  Â  <div id="listRecordYM"></div>
Â  Â  <button class="secondary" onclick="showBox('recordLocBox')">è¿”å›</button>
Â  Â  <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="recordFinalBox">
Â  Â  <h2 id="titleRecordFinal">æ›´è¡¨è©³æƒ…</h2>
Â  Â  <div id="listRecordFinal" style="max-height:450px; overflow-y:auto; padding:5px;"></div>
Â  Â Â 
Â  Â  <button class="secondary" onclick="showBox('boxFinal')">è¿”å›æ˜ŸæœŸåˆ—è¡¨</button>
Â  Â  <button class="secondary" onclick="showBox('menuBox')" style="margin-top:10px;">è¿”å›ä¸»é </button>
</div>

<div class="card" id="supportBox">
Â  Â  <h2>æŠ€è¡“æ”¯æ´</h2>
Â  Â  <p style="font-size: 14px; color: #ff3b30; font-weight: bold; margin-bottom: 15px;">âš ï¸ æœ‰ç·Šæ€¥äº‹è«‹è‡ªè¡Œè¯çµ¡Elmo</p>
Â  Â  <textarea id="supportMsg" rows="4" placeholder="è«‹è¼¸å…¥ç•™è¨€..."></textarea>
Â  Â  <button id="supportBtn" onclick="submitSupport()">æäº¤ç•™è¨€</button>
Â  Â  <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
Â  Â  apiKey: "AIzaSyDTT86mpGJJMByToRMi7b8jjI0LoNJarNo",
Â  Â  authDomain: "sws-ops.firebaseapp.com",
Â  Â  projectId: "sws-ops",
Â  Â  storageBucket: "sws-ops.firebasestorage.app",
Â  Â  messagingSenderId: "985280948590",
Â  Â  appId: "1:985280948590:web:3aad1539136659b4dc797f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwi7PzW1qkDOi7IRTMAnvcalsJUeRuc3-Q8loMUcPhTp6i9CqW0qXFI5zNrE5Y04lW5Eg/exec";
let currentUser = "";
let cachedData = null;
let curL = "";
let curRecordLoc = "";
let selectedSchedule = null;
let clockType = "";

// æ ¸å¿ƒ Helper: çµ±ä¸€è§£ææ—¥æœŸ
function parseDateStr(s) {
Â  Â  if (!s) return ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
Â  Â  let str = String(s);
Â  Â  let cleanStr = str.replace(/[/\sT]/g, "-");
Â  Â  let parts = cleanStr.split("-");
Â  Â  if (parts[0].length === 4) return [parts[0], parseInt(parts[1]).toString(), parseInt(parts[2]).toString()];
Â  Â  if (parts[2] && parts[2].length === 4) return [parts[2], parseInt(parts[1]).toString(), parseInt(parts[0]).toString()];
Â  Â  return ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
}

// æ ¸å¿ƒ Helper: å–å¾—é¦™æ¸¯ä»Šæ—¥æ—¥æœŸæ ¼å¼
const getHKTodayFormats = () => {
Â  Â  const d = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
Â  Â  const d0 = String(d.getDate()).padStart(2, '0');
Â  Â  const m0 = String(d.getMonth() + 1).padStart(2, '0');
Â  Â  const y = d.getFullYear();
Â  Â  return [`${d.getDate()}-${d.getMonth()+1}-${y}`, `${d0}-${m0}-${y}`, `${d.getDate()}/${d.getMonth()+1}/${y}`, `${d0}/${m0}/${y}`];
};

window.showBox = (id) => {
Â  Â  const cards = document.getElementsByClassName('card');
Â  Â  for(let i=0; i<cards.length; i++) cards[i].classList.remove('active');
Â  Â  document.getElementById(id).classList.add('active');
Â  Â  window.scrollTo(0,0);
};

window.doLogin = async () => {
Â  Â  const n = document.getElementById("name").value.trim();
Â  Â  const p = document.getElementById("pin").value.trim();
Â  Â  if(!n || !p) return;
Â  Â Â 
Â  Â  const btn = document.getElementById("loginBtn");
Â  Â  const loading = document.getElementById("loading");
Â  Â  btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;
Â  Â  loading.style.display = "flex";

Â  Â  try {
Â  Â  Â  Â  const q = query(collection(db, "employees"), where("name", "==", n), where("pin", "==", p));
Â  Â  Â  Â  const snap = await getDocs(q);
Â  Â  Â  Â  if(!snap.empty) {
Â  Â  Â  Â  Â  Â  const response = await fetch(`${WEB_APP_URL}?action=refresh&name=${encodeURIComponent(n)}`);
Â  Â  Â  Â  Â  Â  cachedData = await response.json();
Â  Â  Â  Â  Â  Â  currentUser = n;
Â  Â  Â  Â  Â  Â  window.renderUI();
Â  Â  Â  Â  Â  Â  document.getElementById("userHello").innerText = "ä½ å¥½ï¼Œ" + currentUser;
Â  Â  Â  Â  Â  Â  window.showBox('menuBox');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("âŒ ç™»å…¥å¤±æ•—");
Â  Â  Â  Â  }
Â  Â  } catch(e) { alert("é€£ç·šå¤±æ•—: " + e.message); }
Â  Â  btn.innerText = "ç™»å…¥ç³»çµ±"; btn.disabled = false;
Â  Â  loading.style.display = "none";
};

window.renderUI = () => {
Â  Â  let h = "";
Â  Â  const hkt = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
Â  Â  const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];

Â  Â  // å‘¢å€‹ Function å°ˆé–€è² è²¬æ•´å‡ºã€Œè£œé›¶ã€åŒã€Œå””è£œé›¶ã€å…©å€‹ç‰ˆæœ¬ï¼Œç”¨åšŸå°ä½åŒé¡¯ç¤º
Â  Â  const getDateInfo = (d) => {
Â  Â  Â  Â  const dd = String(d.getDate()).padStart(2, '0');
Â  Â  Â  Â  const mm = String(d.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  const y = d.getFullYear();
Â  Â  Â  Â  const d_no_zero = d.getDate();
Â  Â  Â  Â  const m_no_zero = d.getMonth() + 1;
Â  Â  Â  Â  const dayName = dayNames[d.getDay()];

Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  display: `${dd}-${mm}-${y} (${dayName})`, // é¡¯ç¤ºç”¨: 28-02-2026 (SAT)
Â  Â  Â  Â  Â  Â  version1: `${dd}-${mm}-${y}`,Â  Â  Â  Â  Â  Â  Â // å°ä½ç”¨(æœ‰0): 28-02-2026
Â  Â  Â  Â  Â  Â  version2: `${d_no_zero}-${m_no_zero}-${y}` // å°ä½ç”¨(ç„¡0): 28-2-2026
Â  Â  Â  Â  };
Â  Â  };

Â  Â  const dateGroups = [
Â  Â  Â  Â  { label: "æ˜¨æ—¥", info: getDateInfo(new Date(new Date(hkt).setDate(hkt.getDate() - 1))) },
Â  Â  Â  Â  { label: "ä»Šæ—¥", info: getDateInfo(hkt) },
Â  Â  Â  Â  { label: "ç¿Œæ—¥", info: getDateInfo(new Date(new Date(hkt).setDate(hkt.getDate() + 1))) }
Â  Â  ];

Â  Â  dateGroups.forEach(group => {
Â  Â  Â  Â  // æ ¸å¿ƒæ”¹å‹•ï¼šfilter åŒæ™‚æª¢æŸ¥ã€Œæœ‰0ã€åŒã€Œç„¡0ã€å…©å€‹ç‰ˆæœ¬ï¼Œç¢ºä¿ä½  Sheet é»æ‰“éƒ½å°åˆ°
Â  Â  Â  Â  const dayScheds = (cachedData.allSchedules || []).filter(s => {
Â  Â  Â  Â  Â  Â  const sDate = String(s[0]).trim();
Â  Â  Â  Â  Â  Â  return sDate === group.info.version1 || sDate === group.info.version2;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  h += `<div class="date-group">
Â  Â  Â  Â  Â  Â  <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ“… <b>${group.label}</b> (${group.info.display})</span><span>â–¼</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="date-content ${group.label === 'ä»Šæ—¥' ? 'open' : ''}">`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (dayScheds.length === 0) h += `<p style="color:#999; padding:15px; text-align:center;">ç„¡å®‰æ’æ›´æ¬¡</p>`;
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  dayScheds.forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  const uKey = (s[4] || "") + " [" + (s[1] || "") + "]";
Â  Â  Â  Â  Â  Â  Â  Â  // ç´€éŒ„å°ä½éƒ½è¦åŒæ™‚å…¼å®¹å…©å€‹ç‰ˆæœ¬
Â  Â  Â  Â  Â  Â  Â  Â  const hasOut = (cachedData.records || []).some(r =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (r[0] === group.info.version1 || r[0] === group.info.version2) &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r[5] === uKey && r[3] === "æ”¶å·¥"
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  const sParam = JSON.stringify(s).replace(/"/g, '&quot;');
Â  Â  Â  Â  Â  Â  Â  Â  h += `<div class="menu-btn" style="${hasOut ? 'opacity:0.4; pointer-events:none;' : ''}" onclick='window.selectJobFromList(${sParam})'>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><b>${s[3]}</b><br><small>${s[1]} ${s[4]}</small></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:var(--blue);">${hasOut ? "âœ… å·²å®Œæ›´" : "â¯"}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  h += `</div></div>`;
Â  Â  });
Â  Â  document.getElementById("todaySchedules").innerHTML = h;
};

window.selectJobFromList = (s) => {
Â  Â  selectedSchedule = s;
Â  Â  const uKey = (s[4] || "") + " [" + (s[1] || "") + "]";
Â  Â  const hasIn = (cachedData.records || []).some(r => String(r[0]).trim() === String(s[0]).trim() && r[5] === uKey && r[3] === "ç¿»å·¥");
Â  Â  const hasOut = (cachedData.records || []).some(r => String(r[0]).trim() === String(s[0]).trim() && r[5] === uKey && r[3] === "æ”¶å·¥");
Â  Â Â 
Â  Â  document.getElementById("selectedJobTitle").innerText = s[3];
Â  Â  const bIn = document.getElementById("btnIn");
Â  Â  const bOut = document.getElementById("btnOut");
Â  Â Â 
Â  Â  bIn.disabled = hasIn; bIn.innerText = hasIn ? "âœ… å·²å®Œæˆç¿»å·¥" : "ğŸŒ… ç¿»å·¥æ‰“å¡"; bIn.style.opacity = hasIn ? "0.5" : "1";
Â  Â  bOut.disabled = hasOut; bOut.innerText = hasOut ? "âœ… å·²å®Œæˆæ”¶å·¥" : "ğŸŒ‡ æ”¶å·¥æ‰“å¡"; bOut.style.opacity = hasOut ? "0.5" : "1";
Â  Â  window.showBox('typeBox');
};

window.triggerCamera = (t) => {
Â  Â  const todayRecs = (cachedData.records || []).filter(r => getHKTodayFormats().includes(String(r[0]).trim()));
Â  Â  const lastAction = todayRecs.length > 0 ? todayRecs[todayRecs.length - 1][3] : null;

Â  Â  if (t === "æ”¶å·¥" && !lastAction) return alert("âš ï¸ éŒ¯èª¤ï¼šä»Šæ—¥ä»²æœªæœ‰ã€Œç¿»å·¥ã€ç´€éŒ„ï¼");
Â  Â  if (lastAction === t) return alert(`âš ï¸ éŒ¯èª¤ï¼šä½ æœ€å¾Œä¸€ç­†å·²ç¶“ä¿‚ã€Œ${lastAction}ã€ï¼`);

Â  Â  clockType = t;
Â  Â  document.getElementById("cameraInput").click();
};

window.handleCapture = (input) => {
Â  Â  if (!input.files[0]) return;
Â  Â  const loading = document.getElementById("loading");
Â  Â  loading.style.display = "flex";
Â  Â Â 
Â  Â  const reader = new FileReader();
Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  img.onload = () => {
Â  Â  Â  Â  Â  Â  const canvas = document.createElement("canvas");
Â  Â  Â  Â  Â  Â  const maxW = 500;
Â  Â  Â  Â  Â  Â  canvas.width = maxW;
Â  Â  Â  Â  Â  Â  canvas.height = img.height * (maxW / img.width);
Â  Â  Â  Â  Â  Â  canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const detail = (selectedSchedule[4] || "") + " [" + (selectedSchedule[1] || "") + "]";
Â  Â  Â  Â  Â  Â  // å–º body: JSON.stringify(...) ä¹‹å¾Œï¼Œç¢ºä¿å€‹ .then ä¿‚æ¥å¾—ä½å˜…
Â  Â  Â  Â  Â  Â  fetch(WEB_APP_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: "save", name: currentUser, location: selectedSchedule[3], type: clockType, detail: detail, image: canvas.toDataURL("image/jpeg", 0.4) })
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .then(r => r.json()).then(res => {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. æ›´æ–°æˆåŠŸç•«é¢
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("successType").innerText = clockType + "æˆåŠŸ";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("successTime").innerText = res.time;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("successDetail").innerText = selectedSchedule[3];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. ä¿®æ­£è³‡æ–™é †åº (æ—¥æœŸ, å¯¦æ™‚æ™‚é–“, åœ°é», é¡å‹, Event, å°ä½Key)
Â  Â  Â  Â  Â  Â  Â  Â  cachedData.records.push([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedSchedule[0],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  res.time,Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedSchedule[3],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clockType,Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedSchedule[4],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  detailÂ  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  window.renderUI();
Â  Â  Â  Â  Â  Â  Â  Â  window.showBox('successBox');
Â  Â  Â  Â  Â  Â  Â  Â  loading.style.display = "none";
Â  Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  alert("å‚³è¼¸å¤±æ•—ï¼š" + err);
Â  Â  Â  Â  Â  Â  Â  Â  loading.style.display = "none";
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }; // å‘¢å€‹ä¿‚ img.onload å˜…çµå°¾
Â  Â  Â  Â  img.src = e.target.result;
Â  Â  }; // å‘¢å€‹ä¿‚ reader.onload å˜…çµå°¾
Â  Â  reader.readAsDataURL(input.files[0]);
};
// è£œå›ç¼ºå¤±çš„å°èˆªåŠŸèƒ½
window.startSchedFlow = () => {
Â  Â  const locs = [...new Set(cachedData.allSchedules.map(s => s[3]))];
Â  Â  let h = "";
Â  Â  locs.forEach(l => h += `<div class="menu-btn" onclick="chooseLoc('${l}')"><b>${l}</b><span>â¯</span></div>`);
Â  Â  document.getElementById("listLoc").innerHTML = h;
Â  Â  window.showBox('boxLoc');
};

window.startRecordFlow = () => {
Â  Â  const locs = [...new Set(cachedData.records.map(r => r[2]))];
Â  Â  let h = "";
Â  Â  locs.forEach(l => h += `<div class="menu-btn" onclick="chooseRecordLoc('${l}')"><b>${l}</b><span>â¯</span></div>`);
Â  Â  document.getElementById("listRecordLoc").innerHTML = h;
Â  Â  window.showBox('recordLocBox');
};

window.chooseLoc = (l) => {
Â  Â  curL = l;
Â  Â  // åªæå–å¹´ä»½ (ä¾‹å¦‚ 2026å¹´)
Â  Â  const yearSet = [...new Set(cachedData.allSchedules.filter(s => s[3] === l).map(s => {
Â  Â  Â  Â  const p = parseDateStr(s[0]);Â 
Â  Â  Â  Â  return p[0] + "å¹´";
Â  Â  }))].sort().reverse();
Â  Â Â 
Â  Â  let h = "";
Â  Â  yearSet.forEach(y => {
Â  Â  Â  Â  // æ’³å®Œå¹´ä»½æœƒå» chooseYear
Â  Â  Â  Â  h += `<div class="menu-btn" onclick="chooseYear('${y}')"><b>${y}</b><span>â¯</span></div>`;
Â  Â  });
Â  Â  document.getElementById("listYM").innerHTML = h;
Â  Â  document.getElementById("titleYM").innerText = l; // é¡¯ç¤ºåœ°é»å
Â  Â  window.showBox('boxYM');
};

window.chooseYear = (yText) => {
Â  Â  const targetYear = yText.replace("å¹´", "");
Â  Â  const schedules = cachedData.allSchedules.filter(s => {
Â  Â  Â  Â  const p = parseDateStr(s[0]);Â 
Â  Â  Â  Â  return s[3] === curL && p[0] === targetYear;
Â  Â  });

Â  Â  const weeks = {};
Â  Â  schedules.forEach(s => {
Â  Â  Â  Â  const p = parseDateStr(s[0]);
Â  Â  Â  Â  const d = new Date(p[0], p[1]-1, p[2]);
Â  Â  Â  Â  const day = d.getDay();Â 
Â  Â  Â  Â  const diff = d.getDate() - (day === 0 ? 6 : day - 1);Â 
Â  Â  Â  Â  const monday = new Date(new Date(d).setDate(diff));
Â  Â  Â  Â  const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
Â  Â  Â  Â  const weekStr = `${monday.getDate()}/${monday.getMonth()+1} - ${sunday.getDate()}/${sunday.getMonth()+1}`;
Â  Â  Â  Â  if (!weeks[weekStr]) weeks[weekStr] = [];
Â  Â  Â  Â  weeks[weekStr].push(s);
Â  Â  });

Â  Â  // å°‡æ˜ŸæœŸç”±æ–°åˆ°èˆŠæ’ (æœ€è¿‘æœŸå˜…ç¦®æ‹œæ“ºæœ€é ‚)
Â  Â  const sortedWeeks = Object.keys(weeks).sort((a, b) => {
Â  Â  Â  Â  const dateA = parseInt(a.split('/')[0]);
Â  Â  Â  Â  const dateB = parseInt(b.split('/')[0]);
Â  Â  Â  Â  return dateB - dateA;
Â  Â  });

Â  Â  let h = "";
Â  Â  sortedWeeks.forEach(w => {
Â  Â  Â  Â  h += `<div class="menu-btn" onclick="showWeeklyDetail('${w}', '${targetYear}')"><b>${w}</b><span>â¯</span></div>`;
Â  Â  });
Â  Â Â 
Â  Â  document.getElementById("listFinal").innerHTML = h;
Â  Â  document.getElementById("titleFinal").innerText = "é¸æ“‡æ˜ŸæœŸ";
Â  Â  window.showBox('boxFinal');
};

window.showWeeklyDetail = (weekRange, year) => {
Â  Â  // å‘¢åº¦ filter é‚è¼¯ç¶­æŒåŸæ¨£ (æ ¹æ“š weekRange æµæ›´)
Â  Â  const schedules = cachedData.allSchedules.filter(s => {
Â  Â  Â  Â  const p = parseDateStr(s[0]);
Â  Â  Â  Â  const d = new Date(p[0], p[1]-1, p[2]);
Â  Â  Â  Â  const day = d.getDay();
Â  Â  Â  Â  const diff = d.getDate() - (day === 0 ? 6 : day - 1);Â 
Â  Â  Â  Â  const mon = new Date(new Date(d).setDate(diff));
Â  Â  Â  Â  const sun = new Date(new Date(mon).setDate(mon.getDate() + 6));
Â  Â  Â  Â  const range = `${mon.getDate()}/${mon.getMonth()+1} - ${sun.getDate()}/${sun.getMonth()+1}`;
Â  Â  Â  Â  return s[3] === curL && p[0] === year && range === weekRange;
Â  Â  });

Â  Â  const days = {};
Â  Â  const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
Â  Â Â 
Â  Â  schedules.forEach(s => {
Â  Â  Â  Â  if (!days[s[0]]) days[s[0]] = [];
Â  Â  Â  Â  days[s[0]].push(s);
Â  Â  });

Â  Â  let h = "";
Â  Â  const sortedDates = Object.keys(days).sort((a, b) => {
Â  Â  Â  Â  const pa = parseDateStr(a), pb = parseDateStr(b);
Â  Â  Â  Â  return new Date(pa[0], pa[1]-1, pa[2]) - new Date(pb[0], pb[1]-1, pb[2]);
Â  Â  });

Â  Â  sortedDates.forEach(date => {
Â  Â  Â  Â  const p = parseDateStr(date);
Â  Â  Â  Â  const d = new Date(p[0], p[1]-1, p[2]);
Â  Â  Â  Â  const dayName = dayNames[d.getDay()];

Â  Â  Â  Â  // å‘¢åº¦æ”¹å’—ï¼šé¡¯ç¤ºåšè£œé›¶ç‰ˆæœ¬ 28-02-2026
Â  Â  Â  Â  const dd = String(p[2]).padStart(2, '0');
Â  Â  Â  Â  const mm = String(p[1]).padStart(2, '0');
Â  Â  Â  Â  const displayDate = `${dd}-${mm}-${p[0]} (${dayName})`;

Â  Â  Â  Â  h += `<div class="date-group">
Â  Â  Â  Â  Â  Â  <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ“… <b>${displayDate}</b></span><span>â–¼</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="date-content">`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  days[date].forEach(s => {
Â  Â  Â  Â  Â  Â  h += `<div class="record-item">
Â  Â  Â  Â  Â  Â  Â  Â  <b>${s[1]}</b> ${s[4]}<br>
Â  Â  Â  Â  Â  Â  Â  Â  <small style="color:#666;">å´—ä½: ${s[2] || 'ä¸€èˆ¬'}</small>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  h += `</div></div>`;
Â  Â  });

Â  Â  document.getElementById("listRecordFinal").innerHTML = h || "è©²æ˜ŸæœŸç„¡è³‡æ–™";
Â  Â  document.getElementById("titleRecordFinal").innerText = weekRange;
Â  Â  window.showBox('recordFinalBox');
};

window.chooseRecordLoc = (l) => {
Â  Â  window.curRecordLoc = l;
Â  Â Â 
Â  Â  // 1. æµå‡ºæ‰€æœ‰å¹´æœˆ (2026å¹´2æœˆ, 2026å¹´1æœˆ...)
Â  Â  const records = cachedData.records || [];
Â  Â  const ymSet = [...new Set(records.filter(r => r[2] === l).map(r => {
Â  Â  Â  Â  const p = parseDateStr(r[0]);Â 
Â  Â  Â  Â  return p[0] + "å¹´" + p[1] + "æœˆ";
Â  Â  }))].sort().reverse();

Â  Â  // 2. ç”¢ç”Ÿã€Œä¸‹æ‹‰è³‡æ–™å¤¾ã€æ¨™é¡Œ
Â  Â  let h = ymSet.map(ym => {
Â  Â  Â  Â  const safeId = ym.replace(/[å¹´æœˆ]/g, "-");
Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="date-group" style="margin-bottom:12px; border:1px solid #ddd; border-radius:8px; overflow:hidden;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="date-header" onclick="window.chooseRecordYM('${ym}', '${safeId}')" style="background:#f9f9f9; padding:15px; display:flex; justify-content:space-between; cursor:pointer; font-weight:bold; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ“‚ ${ym}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="arrow-${safeId}">â–¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="box-${safeId}" style="display:none; background:#fff; border-top:1px solid #eee;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align:center; padding:15px; color:#999;">è¼‰å…¥ç´€éŒ„ä¸­...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  }).join('');

Â  Â  // 3. æµè¿” listRecordYM å‘¢å€‹å®¹å™¨
Â  Â  const container = document.getElementById("listRecordYM");
Â  Â  if (container) {
Â  Â  Â  Â  container.innerHTML = h || "<p style='text-align:center; padding:20px;'>æ­¤åœ°é»æš«ç„¡ç´€éŒ„</p>";
Â  Â  Â  Â  window.showBox('recordMonthBox');
Â  Â  }
};

window.chooseRecordYM = (ym, safeId) => {
Â  Â  const contentEl = document.getElementById("box-" + safeId);
Â  Â  if (!contentEl) return;
Â  Â Â 
Â  Â  // åŸåœ°é–‹åˆæ•ˆæœ
Â  Â  if (contentEl.style.display === 'block') {
Â  Â  Â  Â  contentEl.style.display = 'none';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const [y, m] = [ym.split("å¹´")[0], ym.split("å¹´")[1].replace("æœˆ","")];
Â  Â  const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];

Â  Â  const logs = (cachedData.records || []).filter(r => {
Â  Â  Â  Â  const p = parseDateStr(r[0]);Â 
Â  Â  Â  Â  return r[2] === window.curRecordLoc && p[0] === y && String(p[1]) === String(m);
Â  Â  });
Â  Â  logs.sort((a, b) => parseInt(parseDateStr(b[0])[2]) - parseInt(parseDateStr(a[0])[2]));

Â  Â  let h = "";
Â  Â  let lastDate = "";

Â  Â  logs.forEach(log => {
Â  Â  Â  Â  const p = parseDateStr(log[0]);
Â  Â  Â  Â  const displayDate = `${String(p[2]).padStart(2, '0')}-${String(p[1]).padStart(2, '0')}-${p[0]}`;
Â  Â  Â  Â  const d = new Date(p[0], parseInt(p[1])-1, parseInt(p[2]));
Â  Â  Â  Â  const dateHeader = `ğŸ“… ${displayDate} (${dayNames[d.getDay()]})`;

Â  Â  Â  Â  // æ’å…¥æ—¥æœŸå¤§æ¨™é¡Œ
Â  Â  Â  Â  if (displayDate !== lastDate) {
Â  Â  Â  Â  Â  Â  h += `<div style="background:#f2f2f2; padding:8px 15px; font-weight:bold; color:#333; border-left:4px solid #007bff; margin-top:15px; text-align:left;">${dateHeader}</div>`;
Â  Â  Â  Â  Â  Â  lastDate = displayDate;
Â  Â  Â  Â  }

Â  Â  Â  Â  // å°ä½ Schedules æ”æ™‚é–“
Â  Â  Â  Â  const sched = (cachedData.allSchedules || []).find(s => {
Â  Â  Â  Â  Â  Â  const sp = parseDateStr(s[0]);
Â  Â  Â  Â  Â  Â  const uKey = (s[4] || "") + " [" + (s[1] || "") + "]";Â 
Â  Â  Â  Â  Â  Â  return sp[0] === p[0] && sp[1] === p[1] && sp[2] === p[2] && uKey === log[5];
Â  Â  Â  Â  });
Â  Â  Â  Â  const schedTime = sched ? sched[1] : "æ›´è¡¨æ™‚é–“æœªæä¾›";

Â  Â  Â  Â  // --- å‘¢åº¦ä¿‚ä½ è¦æ”¹å˜…ä¸‰å±¤æ’ç‰ˆ ---
Â  Â  Â  Â  h += `<div style="padding:12px 15px; border-bottom:1px solid #eee; text-align:left; background:#fff;">
Â  Â  Â  Â  Â  Â  <div style="margin-bottom:6px;">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="tag ${log[3]==='æ”¶å·¥'?'tag-out':'tag-in'}">${log[3]}</span>Â 
Â  Â  Â  Â  Â  Â  Â  Â  <b style="font-size:1.05em; color:#222;">${displayDate} ${schedTime}</b>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="color:#007bff; font-size:0.95em; margin-bottom:4px; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  æ‰“å¡æ™‚é–“âœ… ${log[1]}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="color:#666; font-size:0.9em; padding-left:2px;">
Â  Â  Â  Â  Â  Â  Â  Â  ${log[4]}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
Â  Â  });

Â  Â  contentEl.innerHTML = h || "<p style='padding:20px; text-align:center;'>ç„¡ç´€éŒ„</p>";
Â  Â  contentEl.style.display = 'block';
};
window.submitSupport = () => {
Â  Â  const msg = document.getElementById("supportMsg").value.trim();
Â  Â  if(!msg) return;
Â  Â  fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "support", name: currentUser, message: msg }) })
Â  Â  .then(() => { alert("æ”¶åˆ°ä½ ğŸ«¡"); window.showBox('menuBox'); });
};
</script>
</body>
</html>

come on final check
