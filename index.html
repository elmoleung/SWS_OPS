<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SWS/OPSå“¡å·¥æ‰“å¡ç³»çµ±</title>
    <style>
        :root { --primary: #000; --bg: #f2f2f7; --success: #34c759; --blue: #007aff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin:0; font-family:-apple-system, 'SF Pro Display', sans-serif; background: var(--bg); color: #1c1c1e; }
        .card { background:white; width:92%; max-width:400px; padding:25px; border-radius:28px; box-shadow:0 10px 30px rgba(0,0,0,0.08); text-align:center; margin: 20px auto; display: none; }
        .active { display: block !important; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        h2 { margin-bottom:20px; font-size:22px; font-weight:700; }
        button { width:100%; padding:18px; border-radius:16px; border:none; background:var(--primary); color:white; font-size:16px; font-weight:600; margin-top:10px; cursor:pointer; }
        button:active { opacity: 0.7; transform: scale(0.98); }
        button:disabled { background: #ccc !important; }
        .secondary { background:#e5e5e7; color:#000; }
        .home-link { color: var(--blue); cursor: pointer; display: block; margin-top: 15px; font-size: 15px; font-weight: 600; text-decoration: none; }
        #btnIn { background: #FFFBCC; color: #856404; border: 1px solid #ffeeba; }
        #btnOut { background: #CCE5FF; color: #004085; border: 1px solid #b8daff; }
        .menu-btn { text-align:left; padding:18px; background:#fff; margin-bottom:12px; border-radius:18px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .record-item { text-align:left; padding:15px; border-bottom:1px solid #f2f2f7; font-size:14px; position: relative; }
        .tag { font-size:11px; padding:4px 10px; border-radius:8px; font-weight:800; display: inline-block; min-width: 50px; text-align: center; }
        .tag-in { background: #FFFBCC; color: #856404; border: 0.5px solid #ffeeba; }
        .tag-out { background: #CCE5FF; color: #004085; border: 0.5px solid #b8daff; }
        input, textarea { width:100%; padding:18px; margin-bottom:15px; border-radius:16px; border:1.5px solid #d1d1d6; font-size:16px; outline:none; }
        .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; backdrop-filter: blur(3px); }
        .big-check { font-size: 70px; margin-bottom: 10px; }
        .date-group { border: 1px solid #e5e5e7; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; }
        .date-header { background: #f9f9fb; padding: 15px; text-align: left; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .date-content { display: none; padding: 0 15px; background: #fff; border-top: 1px solid #eee; }
        .date-content.open { display: block; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay"><b>âŒ› è™•ç†ä¸­...</b></div>

<div class="card active" id="loginBox">
    <div style="font-size: 50px; margin-bottom: 15px;">ğŸ’¼</div>
    <h2>SWS/OPS æ‰“å¡ç³»çµ±</h2>
    <input id="name" placeholder="ç™»å…¥åç¨±" autocomplete="off">
    <input id="pin" type="password" placeholder="PINç¢¼" inputmode="numeric">
    <button id="loginBtn" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
</div>

<div class="card" id="menuBox">
    <h2 id="userHello">ä½ å¥½</h2>
    <div class="menu-btn" onclick="showBox('clockInBox')"><div>ğŸ“ <b>æˆ‘è¦æ‰“å¡ï¼</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="startSchedFlow()"><div>ğŸ“… <b>æˆ‘æƒ³ç‡æ›´ï¼</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="startRecordFlow()"><div>ğŸ“œ <b>æ‰“å¡ç´€éŒ„</b></div><span>â¯</span></div>
    <div class="menu-btn" onclick="showBox('supportBox')"><div>ğŸ› ï¸ <b>æŠ€è¡“æ”¯æ´</b></div><span>â¯</span></div>
    <button class="secondary" onclick="location.reload()" style="margin-top:20px;">ç™»å‡ºç³»çµ±</button>
</div>

<div class="card" id="clockInBox">
    <h2>æœ€è¿‘ä¸‰æ—¥(æ˜¨/ä»Š/æ˜)æ›´æ¬¡</h2>
    <div id="todaySchedules"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<div class="card" id="typeBox">
    <h2 id="selectedJobTitle">åœ°é»</h2>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleCapture(this)" style="display:none">
    <button id="btnIn" onclick="triggerCamera('ç¿»å·¥')">ğŸŒ… ç¿»å·¥æ‰“å¡</button>
    <button id="btnOut" onclick="triggerCamera('æ”¶å·¥')">ğŸŒ‡ æ”¶å·¥æ‰“å¡</button>
    <button class="secondary" onclick="showBox('clockInBox')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="successBox">
    <div class="big-check">âœ…</div>
    <h2 id="successType">æ‰“å¡æˆåŠŸ</h2>
    <p id="successTime" style="font-size:20px; font-weight:bold; margin:10px 0;"></p>
    <p id="successDetail" style="color:#666; font-size:14px;"></p>
    <button onclick="showBox('menuBox')">è¿”å›ä¸»é </button>
</div>

<div class="card" id="boxLoc">
    <h2>é¸æ“‡åœ°é»</h2>
    <div id="listLoc"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<div class="card" id="boxYM">
    <h2 id="titleYM">é¸æ“‡å¹´ä»½</h2>
    <div id="listYM"></div>
    <button class="secondary" onclick="showBox('boxLoc')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="boxFinal">
    <h2 id="titleFinal">é¸æ“‡æ˜ŸæœŸ</h2>
    <div id="listFinal" style="max-height:400px; overflow-y:auto;"></div>
    <button class="secondary" onclick="showBox('boxYM')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="recordLocBox">
    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ¢</div>
    <h2>é¸æ“‡ç´€éŒ„åœ°é»</h2>
    <div id="listRecordLoc"></div>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›ä¸»é </button>
</div>

<div class="card" id="recordMonthBox">
    <h2 id="titleRecordYM">é¸æ“‡æœˆä»½</h2>
    <div id="listRecordYM"></div>
    <button class="secondary" onclick="showBox('recordLocBox')">è¿”å›</button>
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="recordFinalBox">
    <h2 id="titleRecordFinal">æ‰“å¡ç´€éŒ„</h2>
    <div id="listRecordFinal" style="max-height:450px; overflow-y:auto; padding:5px;"></div>
    
    <button class="secondary" onclick="showBox('boxFinal')">è¿”å›</button>
    
    <a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a>
</div>

<div class="card" id="supportBox">
    <h2>æŠ€è¡“æ”¯æ´</h2>
    <p style="font-size: 14px; color: #ff3b30; font-weight: bold; margin-bottom: 15px;">âš ï¸ æœ‰ç·Šæ€¥äº‹è«‹è‡ªè¡Œè¯çµ¡Elmo</p>
    <textarea id="supportMsg" rows="4" placeholder="è«‹è¼¸å…¥ç•™è¨€..."></textarea>
    <button id="supportBtn" onclick="submitSupport()">æäº¤ç•™è¨€</button>
    <button class="secondary" onclick="showBox('menuBox')">è¿”å›</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDTT86mpGJJMByToRMi7b8jjI0LoNJarNo",
    authDomain: "sws-ops.firebaseapp.com",
    projectId: "sws-ops",
    storageBucket: "sws-ops.firebasestorage.app",
    messagingSenderId: "985280948590",
    appId: "1:985280948590:web:3aad1539136659b4dc797f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwi7PzW1qkDOi7IRTMAnvcalsJUeRuc3-Q8loMUcPhTp6i9CqW0qXFI5zNrE5Y04lW5Eg/exec";
let currentUser = "";
let cachedData = null;
let curL = "";
let curRecordLoc = "";
let selectedSchedule = null;
let clockType = "";

// æ ¸å¿ƒ Helper: çµ±ä¸€è§£ææ—¥æœŸ
function parseDateStr(s) {
    if (!s) return ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
    let str = String(s);
    let cleanStr = str.replace(/[/\sT]/g, "-");
    let parts = cleanStr.split("-");
    if (parts[0].length === 4) return [parts[0], parseInt(parts[1]).toString(), parseInt(parts[2]).toString()];
    if (parts[2] && parts[2].length === 4) return [parts[2], parseInt(parts[1]).toString(), parseInt(parts[0]).toString()];
    return ["æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥"];
}

// æ ¸å¿ƒ Helper: å–å¾—é¦™æ¸¯ä»Šæ—¥æ—¥æœŸæ ¼å¼
const getHKTodayFormats = () => {
    const d = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
    const d0 = String(d.getDate()).padStart(2, '0');
    const m0 = String(d.getMonth() + 1).padStart(2, '0');
    const y = d.getFullYear();
    return [`${d.getDate()}-${d.getMonth()+1}-${y}`, `${d0}-${m0}-${y}`, `${d.getDate()}/${d.getMonth()+1}/${y}`, `${d0}/${m0}/${y}`];
};

window.showBox = (id) => {
    const cards = document.getElementsByClassName('card');
    for(let i=0; i<cards.length; i++) cards[i].classList.remove('active');
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
};

window.doLogin = async () => {
    const n = document.getElementById("name").value.trim();
    const p = document.getElementById("pin").value.trim();
    if(!n || !p) return;
    
    const btn = document.getElementById("loginBtn");
    const loading = document.getElementById("loading");
    btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true;
    loading.style.display = "flex";

    try {
        const q = query(collection(db, "employees"), where("name", "==", n), where("pin", "==", p));
        const snap = await getDocs(q);
        if(!snap.empty) {
            const response = await fetch(`${WEB_APP_URL}?action=refresh&name=${encodeURIComponent(n)}`);
            cachedData = await response.json();
            currentUser = n;
            window.renderUI();
            document.getElementById("userHello").innerText = "ä½ å¥½ï¼Œ" + currentUser;
            window.showBox('menuBox');
        } else {
            alert("âŒ ç™»å…¥å¤±æ•—");
        }
    } catch(e) { alert("é€£ç·šå¤±æ•—: " + e.message); }
    btn.innerText = "ç™»å…¥ç³»çµ±"; btn.disabled = false;
    loading.style.display = "none";
};

window.renderUI = () => {
    let h = "";
    const hkt = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
    const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];

    // å‘¢å€‹ Function å°ˆé–€è² è²¬æ•´å‡ºã€Œè£œé›¶ã€åŒã€Œå””è£œé›¶ã€å…©å€‹ç‰ˆæœ¬ï¼Œç”¨åšŸå°ä½åŒé¡¯ç¤º
    const getDateInfo = (d) => {
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const y = d.getFullYear();
        const d_no_zero = d.getDate();
        const m_no_zero = d.getMonth() + 1;
        const dayName = dayNames[d.getDay()];

        return {
            display: `${dd}-${mm}-${y} (${dayName})`, // é¡¯ç¤ºç”¨: 28-02-2026 (SAT)
            version1: `${dd}-${mm}-${y}`,             // å°ä½ç”¨(æœ‰0): 28-02-2026
            version2: `${d_no_zero}-${m_no_zero}-${y}` // å°ä½ç”¨(ç„¡0): 28-2-2026
        };
    };

    const dateGroups = [
        { label: "æ˜¨æ—¥", info: getDateInfo(new Date(new Date(hkt).setDate(hkt.getDate() - 1))) },
        { label: "ä»Šæ—¥", info: getDateInfo(hkt) },
        { label: "ç¿Œæ—¥", info: getDateInfo(new Date(new Date(hkt).setDate(hkt.getDate() + 1))) }
    ];

    dateGroups.forEach(group => {
        // æ ¸å¿ƒæ”¹å‹•ï¼šfilter åŒæ™‚æª¢æŸ¥ã€Œæœ‰0ã€åŒã€Œç„¡0ã€å…©å€‹ç‰ˆæœ¬ï¼Œç¢ºä¿ä½  Sheet é»æ‰“éƒ½å°åˆ°
        const dayScheds = (cachedData.allSchedules || []).filter(s => {
            const sDate = String(s[0]).trim();
            return sDate === group.info.version1 || sDate === group.info.version2;
        });
        
        h += `<div class="date-group">
            <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
                <span>ğŸ“… <b>${group.label}</b> (${group.info.display})</span><span>â–¼</span>
            </div>
            <div class="date-content ${group.label === 'ä»Šæ—¥' ? 'open' : ''}">`;
        
        if (dayScheds.length === 0) h += `<p style="color:#999; padding:15px; text-align:center;">ç„¡å®‰æ’æ›´æ¬¡</p>`;
        else {
            dayScheds.forEach(s => {
                const uKey = (s[4] || "") + " [" + (s[1] || "") + "]";
                // ç´€éŒ„å°ä½éƒ½è¦åŒæ™‚å…¼å®¹å…©å€‹ç‰ˆæœ¬
                const hasOut = (cachedData.records || []).some(r => 
                    (r[0] === group.info.version1 || r[0] === group.info.version2) && 
                    r[5] === uKey && r[3] === "æ”¶å·¥"
                );
                const sParam = JSON.stringify(s).replace(/"/g, '&quot;');
                h += `<div class="menu-btn" style="${hasOut ? 'opacity:0.4; pointer-events:none;' : ''}" onclick='window.selectJobFromList(${sParam})'>
                    <div><b>${s[3]}</b><br><small>${s[1]} ${s[4]}</small></div>
                    <span style="color:var(--blue);">${hasOut ? "âœ… å·²å®Œæ›´" : "â¯"}</span>
                </div>`;
            });
        }
        h += `</div></div>`;
    });
    document.getElementById("todaySchedules").innerHTML = h;
};

window.selectJobFromList = (s) => {
    selectedSchedule = s;
    const uKey = (s[4] || "") + " [" + (s[1] || "") + "]";
    const hasIn = (cachedData.records || []).some(r => String(r[0]).trim() === String(s[0]).trim() && r[5] === uKey && r[3] === "ç¿»å·¥");
    const hasOut = (cachedData.records || []).some(r => String(r[0]).trim() === String(s[0]).trim() && r[5] === uKey && r[3] === "æ”¶å·¥");
    
    document.getElementById("selectedJobTitle").innerText = s[3];
    const bIn = document.getElementById("btnIn");
    const bOut = document.getElementById("btnOut");
    
    bIn.disabled = hasIn; bIn.innerText = hasIn ? "âœ… å·²å®Œæˆç¿»å·¥" : "ğŸŒ… ç¿»å·¥æ‰“å¡"; bIn.style.opacity = hasIn ? "0.5" : "1";
    bOut.disabled = hasOut; bOut.innerText = hasOut ? "âœ… å·²å®Œæˆæ”¶å·¥" : "ğŸŒ‡ æ”¶å·¥æ‰“å¡"; bOut.style.opacity = hasOut ? "0.5" : "1";
    window.showBox('typeBox');
};

window.triggerCamera = (t) => {
    const todayRecs = (cachedData.records || []).filter(r => getHKTodayFormats().includes(String(r[0]).trim()));
    const lastAction = todayRecs.length > 0 ? todayRecs[todayRecs.length - 1][3] : null;

    if (t === "æ”¶å·¥" && !lastAction) return alert("âš ï¸ éŒ¯èª¤ï¼šä»Šæ—¥ä»²æœªæœ‰ã€Œç¿»å·¥ã€ç´€éŒ„ï¼");
    if (lastAction === t) return alert(`âš ï¸ éŒ¯èª¤ï¼šä½ æœ€å¾Œä¸€ç­†å·²ç¶“ä¿‚ã€Œ${lastAction}ã€ï¼`);

    clockType = t;
    document.getElementById("cameraInput").click();
};

window.handleCapture = (input) => {
    if (!input.files[0]) return;
    const loading = document.getElementById("loading");
    loading.style.display = "flex";
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement("canvas");
            const maxW = 500;
            canvas.width = maxW;
            canvas.height = img.height * (maxW / img.width);
            canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
            
            const detail = (selectedSchedule[4] || "") + " [" + (selectedSchedule[1] || "") + "]";
            fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify({ action: "save", name: currentUser, location: selectedSchedule[3], type: clockType, detail: detail, image: canvas.toDataURL("image/jpeg", 0.4) })
            }).then(r => r.json()).then(res => {
                document.getElementById("successType").innerText = clockType + "æˆåŠŸ";
                document.getElementById("successTime").innerText = res.time;
                document.getElementById("successDetail").innerText = selectedSchedule[3];
                
                cachedData.records.push([selectedSchedule[0], currentUser, selectedSchedule[3], clockType, res.time, detail]);
                window.renderUI();
                window.showBox('successBox');
                loading.style.display = "none";
            });
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
};

// è£œå›ç¼ºå¤±çš„å°èˆªåŠŸèƒ½
window.startSchedFlow = () => {
    const locs = [...new Set(cachedData.allSchedules.map(s => s[3]))];
    let h = "";
    locs.forEach(l => h += `<div class="menu-btn" onclick="chooseLoc('${l}')"><b>${l}</b><span>â¯</span></div>`);
    document.getElementById("listLoc").innerHTML = h;
    window.showBox('boxLoc');
};

window.startRecordFlow = () => {
    const locs = [...new Set(cachedData.records.map(r => r[2]))];
    let h = "";
    locs.forEach(l => h += `<div class="menu-btn" onclick="chooseRecordLoc('${l}')"><b>${l}</b><span>â¯</span></div>`);
    document.getElementById("listRecordLoc").innerHTML = h;
    window.showBox('recordLocBox');
};

window.chooseLoc = (l) => {
    curL = l;
    // åªæå–å¹´ä»½ (ä¾‹å¦‚ 2026å¹´)
    const yearSet = [...new Set(cachedData.allSchedules.filter(s => s[3] === l).map(s => {
        const p = parseDateStr(s[0]); 
        return p[0] + "å¹´";
    }))].sort().reverse();
    
    let h = "";
    yearSet.forEach(y => {
        // æ’³å®Œå¹´ä»½æœƒå» chooseYear
        h += `<div class="menu-btn" onclick="chooseYear('${y}')"><b>${y}</b><span>â¯</span></div>`;
    });
    document.getElementById("listYM").innerHTML = h;
    document.getElementById("titleYM").innerText = l; // é¡¯ç¤ºåœ°é»å
    window.showBox('boxYM');
};

window.chooseYear = (yText) => {
    const targetYear = yText.replace("å¹´", "");
    const schedules = cachedData.allSchedules.filter(s => {
        const p = parseDateStr(s[0]); 
        return s[3] === curL && p[0] === targetYear;
    });

    const weeks = {};
    schedules.forEach(s => {
        const p = parseDateStr(s[0]);
        const d = new Date(p[0], p[1]-1, p[2]);
        const day = d.getDay(); 
        const diff = d.getDate() - (day === 0 ? 6 : day - 1); 
        const monday = new Date(new Date(d).setDate(diff));
        const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
        const weekStr = `${monday.getDate()}/${monday.getMonth()+1} - ${sunday.getDate()}/${sunday.getMonth()+1}`;
        if (!weeks[weekStr]) weeks[weekStr] = [];
        weeks[weekStr].push(s);
    });

    // å°‡æ˜ŸæœŸç”±æ–°åˆ°èˆŠæ’ (æœ€è¿‘æœŸå˜…ç¦®æ‹œæ“ºæœ€é ‚)
    const sortedWeeks = Object.keys(weeks).sort((a, b) => {
        const dateA = parseInt(a.split('/')[0]);
        const dateB = parseInt(b.split('/')[0]);
        return dateB - dateA;
    });

    let h = "";
    sortedWeeks.forEach(w => {
        h += `<div class="menu-btn" onclick="showWeeklyDetail('${w}', '${targetYear}')"><b>${w}</b><span>â¯</span></div>`;
    });
    
    document.getElementById("listFinal").innerHTML = h;
    document.getElementById("titleFinal").innerText = "é¸æ“‡æ˜ŸæœŸ";
    window.showBox('boxFinal');
};

window.showWeeklyDetail = (weekRange, year) => {
    // å‘¢åº¦ filter é‚è¼¯ç¶­æŒåŸæ¨£ (æ ¹æ“š weekRange æµæ›´)
    const schedules = cachedData.allSchedules.filter(s => {
        const p = parseDateStr(s[0]);
        const d = new Date(p[0], p[1]-1, p[2]);
        const day = d.getDay();
        const diff = d.getDate() - (day === 0 ? 6 : day - 1); 
        const mon = new Date(new Date(d).setDate(diff));
        const sun = new Date(new Date(mon).setDate(mon.getDate() + 6));
        const range = `${mon.getDate()}/${mon.getMonth()+1} - ${sun.getDate()}/${sun.getMonth()+1}`;
        return s[3] === curL && p[0] === year && range === weekRange;
    });

    const days = {};
    const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
    
    schedules.forEach(s => {
        if (!days[s[0]]) days[s[0]] = [];
        days[s[0]].push(s);
    });

    let h = "";
    const sortedDates = Object.keys(days).sort((a, b) => {
        const pa = parseDateStr(a), pb = parseDateStr(b);
        return new Date(pa[0], pa[1]-1, pa[2]) - new Date(pb[0], pb[1]-1, pb[2]);
    });

    sortedDates.forEach(date => {
        const p = parseDateStr(date);
        const d = new Date(p[0], p[1]-1, p[2]);
        const dayName = dayNames[d.getDay()];

        // å‘¢åº¦æ”¹å’—ï¼šé¡¯ç¤ºåšè£œé›¶ç‰ˆæœ¬ 28-02-2026
        const dd = String(p[2]).padStart(2, '0');
        const mm = String(p[1]).padStart(2, '0');
        const displayDate = `${dd}-${mm}-${p[0]} (${dayName})`;

        h += `<div class="date-group">
            <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
                <span>ğŸ“… <b>${displayDate}</b></span><span>â–¼</span>
            </div>
            <div class="date-content">`;
        
        days[date].forEach(s => {
            h += `<div class="record-item">
                <b>${s[1]}</b> ${s[4]}<br>
                <small style="color:#666;">å´—ä½: ${s[2] || 'ä¸€èˆ¬'}</small>
            </div>`;
        });
        h += `</div></div>`;
    });

    document.getElementById("listRecordFinal").innerHTML = h || "è©²æ˜ŸæœŸç„¡è³‡æ–™";
    document.getElementById("titleRecordFinal").innerText = weekRange;
    window.showBox('recordFinalBox');
};

window.chooseRecordLoc = (l) => {
    window.curRecordLoc = l;
    
    // 1. æµå‡ºå‘¢å€‹åœ°é»æ‰€æœ‰å‡ºç¾éå˜… å¹´æœˆ
    const ymSet = [...new Set((cachedData.records || []).filter(r => r[2] === l).map(r => {
        const p = parseDateStr(r[0]); 
        return p[0] + "å¹´" + p[1] + "æœˆ";
    }))].sort().reverse();

    // 2. ç”¢ç”Ÿã€Œä¸‹æ‹‰å¼ã€å˜…æ¨™é¡Œ
    let h = ymSet.map(ym => `
        <div class="date-group" style="margin-bottom:10px;">
            <div class="date-header" onclick="window.chooseRecordYM('${ym}')" style="background:#f8f8f8; border:1px solid #ddd; padding:12px; display:flex; justify-content:space-between; cursor:pointer;">
                <span>ğŸ“‚ <b>${ym}</b></span><span>â–¼</span>
            </div>
            <div id="content-${ym}" class="date-content" style="display:none; background:#fff;">
                <p style="text-align:center; padding:15px; color:#999;">è¼‰å…¥ç´€éŒ„ä¸­...</p>
            </div>
        </div>
    `).join('');

    // 3. å¡å…¥åŸæœ¬é¡¯ç¤ºå¹´æœˆå˜…ä½ç½® (è«‹æª¢æŸ¥ä½ åŸæœ¬ HTML å€‹ ID ä¿‚å’ª listRecordYM)
    document.getElementById("listRecordYM").innerHTML = h || "<p style='text-align:center; padding:20px;'>æš«ç„¡ç´€éŒ„</p>";
    window.showBox('recordMonthBox');
};

window.chooseRecordYM = (ym) => {
    const contentEl = document.getElementById(`content-${ym}`);
    if (!contentEl) return;
    
    // é–‹åˆæ•ˆæœ
    if (contentEl.style.display === 'block') {
        contentEl.style.display = 'none';
        return;
    }
    
    const [y, m] = [ym.split("å¹´")[0], ym.split("å¹´")[1].replace("æœˆ","")];
    const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];

    const logs = (cachedData.records || []).filter(r => {
        const p = parseDateStr(r[0]); 
        return r[2] === window.curRecordLoc && p[0] === y && p[1] === String(m);
    });

    logs.sort((a, b) => {
        const pa = parseDateStr(a[0]), pb = parseDateStr(b[0]);
        return parseInt(pb[2]) - parseInt(pa[2]);
    });

    let h = "";
    let lastDate = "";

    logs.forEach(log => {
        const p = parseDateStr(log[0]);
        const d = new Date(p[0], p[1]-1, p[2]);
        const dayName = dayNames[d.getDay()];
        const displayDate = `${String(p[2]).padStart(2, '0')}-${String(p[1]).padStart(2, '0')}-${p[0]}`;
        const dateHeader = `ğŸ“… ${displayDate} (${dayName})`;

        if (displayDate !== lastDate) {
            h += `<div style="background:#f2f2f2; padding:8px 15px; font-weight:bold; color:#333; border-left:4px solid var(--blue); margin-top:15px;">${dateHeader}</div>`;
            lastDate = displayDate;
        }

        // è·¨ Sheet å°ä½ï¼šæµè¿” Schedules å˜…åŸå®šæ™‚é–“
        const sched = (cachedData.allSchedules || []).find(s => {
            const sp = parseDateStr(s[0]);
            // æ ¹æ“šä½ æä¾›çš„ log[5] (å³ä¿‚ Elmo [å“¡å·¥å]) åšŸå°ä½
            const uKey = (s[4] || "") + " [" + (s[1] || "") + "]"; 
            return sp[0] === p[0] && sp[1] === p[1] && sp[2] === p[2] && uKey === log[5];
        });

        const schedTime = sched ? sched[1] : "æ›´è¡¨æ™‚é–“æœªæä¾›";

        h += `<div class="record-item" style="padding:12px 15px; border-bottom:1px solid #eee; background:#fff;">
            <div style="margin-bottom:6px;">
                <span class="tag ${log[3]==='æ”¶å·¥'?'tag-out':'tag-in'}">${log[3]}</span> 
                <b style="font-size:1.05em; color:#222;">${displayDate} ${schedTime}</b>
            </div>
            
            <div style="color:var(--blue); font-size:0.95em; margin-bottom:4px; font-weight:500;">
                æ‰“å¡æ™‚é–“âœ… ${log[1]}
            </div>
            
            <div style="color:#666; font-size:0.9em; padding-left:2px;">
                ${log[4]}
            </div>
        </div>`;
    });

    contentEl.innerHTML = h || "<p style='padding:20px; text-align:center; color:#999;'>ç„¡ç´€éŒ„</p>";
    contentEl.style.display = 'block';
};

window.submitSupport = () => {
    const msg = document.getElementById("supportMsg").value.trim();
    if(!msg) return;
    fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "support", name: currentUser, message: msg }) })
    .then(() => { alert("æ”¶åˆ°ä½ ğŸ«¡"); window.showBox('menuBox'); });
};
</script>
</body>
</html>
