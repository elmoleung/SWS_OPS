<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SWS/OPSå“¡å·¥æ‰“å¡ç³»çµ±</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5968/5968313.png">
<style>:root { --primary: #000; --bg: #f2f2f7; --success: #34c759; --blue: #007aff; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin:0; font-family:-apple-system, 'SF Pro Display', sans-serif; background: var(--bg); color: #1c1c1e; }
.card {background:white; width:92%; max-width:400px; padding:25px;
border-radius:28px; box-shadow:0 10px 30px rgba(0,0,0,0.08);
text-align:center; margin: 20px auto; display: none;
}.active { display: block !important; animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
h2 { margin-bottom:20px; font-size:22px; font-weight:700; }
button { width:100%; padding:18px; border-radius:16px; border:none; background:var(--primary); color:white; font-size:16px; font-weight:600; margin-top:10px; cursor:pointer; }
button:active { opacity: 0.7; transform: scale(0.98); }
button:disabled { background: #ccc !important; }
.secondary { background:#e5e5e7; color:#000; }
.home-link { color: var(--blue); cursor: pointer; display: block; margin-top: 15px; font-size: 15px; font-weight: 600; text-decoration: none; }
#btnIn { background: #FFFBCC; color: #856404; border: 1px solid #ffeeba; }
#btnOut { background: #CCE5FF; color: #004085; border: 1px solid #b8daff; }
.menu-btn { text-align:left; padding:18px; background:#fff; margin-bottom:12px; border-radius:18px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.record-item { text-align:left; padding:15px; border-bottom:1px solid #f2f2f7; font-size:14px; position: relative; }
.tag { font-size:11px; padding:4px 10px; border-radius:8px; font-weight:800; display: inline-block; min-width: 50px; text-align: center; }
.tag-in { background: #FFFBCC; color: #856404; border: 0.5px solid #ffeeba; }
.tag-out { background: #CCE5FF; color: #004085; border: 0.5px solid #b8daff; }
input, textarea { width:100%; padding:18px; margin-bottom:15px; border-radius:16px; border:1.5px solid #d1d1d6; font-size:16px; outline:none; }
.loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; backdrop-filter: blur(3px); }
.big-check { font-size: 70px; margin-bottom: 10px; }
.date-group { border: 1px solid #e5e5e7; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; }
.date-header { background: #f9f9fb; padding: 15px; text-align: left; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.date-content { display: none; padding: 0 15px; background: #fff; border-top: 1px solid #eee; }
.date-content.open { display: block; }
</style>
</head>
<body>

<div id="loading" class="loading-overlay"><b>âŒ› è™•ç†ä¸­...</b></div>

<div class="card active" id="loginBox">
  <div style="font-size: 50px; margin-bottom: 15px;">ğŸ’¼</div>
  <h2>SWS/OPS æ‰“å¡ç³»çµ±</h2>
  <input id="name" placeholder="ç™»å…¥åç¨±" autocomplete="off">
  <input id="pin" type="password" placeholder="PINç¢¼" inputmode="numeric">
  <button id="loginBtn" onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
</div>

<div class="card" id="menuBox">
  <h2 id="userHello">ä½ å¥½</h2>
  <div class="menu-btn" onclick="showBox('clockInBox')"><div>ğŸ“ <b>æˆ‘è¦æ‰“å¡ï¼</b></div><span>â¯</span></div>
  <div class="menu-btn" onclick="startSchedFlow()"><div>ğŸ“… <b>æˆ‘æƒ³ç‡æ›´ï¼</b></div><span>â¯</span></div>
  <div class="menu-btn" onclick="startRecordFlow()"><div>ğŸ“œ <b>æ‰“å¡ç´€éŒ„</b></div><span>â¯</span></div>
  <div class="menu-btn" onclick="showBox('supportBox')"><div>ğŸ› ï¸ <b>æŠ€è¡“æ”¯æ´</b></div><span>â¯</span></div>
  <button class="secondary" onclick="doLogout()" style="margin-top:20px;">ç™»å‡ºç³»çµ±</button>
</div>

<div class="card" id="clockInBox"><h2>ä»Šæ—¥æ›´æ¬¡</h2><div id="todaySchedules"></div><button class="secondary" onclick="showBox('menuBox')">è¿”å›</button></div>
<div class="card" id="typeBox"><h2 id="selectedJobTitle">åœ°é»</h2><input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleCapture(this)" style="display:none"><button id="btnIn" onclick="triggerCamera('ç¿»å·¥')">ğŸŒ… ç¿»å·¥æ‰“å¡</button><button id="btnOut" onclick="triggerCamera('æ”¶å·¥')">ğŸŒ‡ æ”¶å·¥æ‰“å¡</button><button class="secondary" onclick="showBox('clockInBox')">è¿”å›</button><a class="home-link" onclick="showBox('menuBox')">è¿”å›ä¸»é </a></div>
<div class="card" id="successBox"><div class="big-check">âœ…</div><h2 id="successType">æ‰“å¡æˆåŠŸ</h2><p id="successTime" style="font-size:20px; font-weight:bold; margin:10px 0;"></p><p id="successDetail" style="color:#666; font-size:14px;"></p><button onclick="showBox('menuBox')">è¿”å›ä¸»é </button></div>
<div class="card" id="recordLocBox"><h2>é¸æ“‡ç´€éŒ„åœ°é»</h2><div id="listRecordLoc"></div><button class="secondary" onclick="showBox('menuBox')">è¿”å›ä¸»é </button></div>
<div class="card" id="recordMonthBox"><h2 id="titleRecordYM">é¸æ“‡æœˆä»½</h2><div id="listRecordYM"></div><button class="secondary" onclick="showBox('recordLocBox')">è¿”å›</button></div>
<div class="card" id="recordFinalBox"><h2 id="titleRecordFinal">æ‰“å¡ç´€éŒ„</h2><div id="listRecordFinal" style="max-height:450px; overflow-y:auto; padding:5px;"></div><button class="secondary" onclick="showBox('recordMonthBox')">è¿”å›</button></div>
<div class="card" id="supportBox"><h2>æŠ€è¡“æ”¯æ´</h2><textarea id="supportMsg" rows="4" placeholder="è«‹è¼¸å…¥ç•™è¨€..."></textarea><button id="supportBtn" onclick="submitSupport()">æäº¤ç•™è¨€</button><button class="secondary" onclick="showBox('menuBox')">è¿”å›</button></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDTT86mpGJJMByToRMi7b8jjI0LoNJarNo",
    authDomain: "sws-ops.firebaseapp.com",
    projectId: "sws-ops",
    storageBucket: "sws-ops.firebasestorage.app",
    messagingSenderId: "985280948590",
    appId: "1:985280948590:web:3aad1539136659b4dc797f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentUserData = null;
  let cachedRecords = [];

  // --- åŸºç¤å°èˆª ---
  window.showBox = (id) => {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
  };

  // --- ç™»å…¥åŠŸèƒ½ (æ”¹ç”¨ Firebase) ---
  window.doLogin = async () => {
    const n = document.getElementById("name").value.trim();
    const p = document.getElementById("pin").value.trim();
    if(!n || !p) return;
    
    const btn = document.getElementById("loginBtn");
    btn.innerText = "é©—è­‰ä¸­...";
    btn.disabled = true;

    try {
      const q = query(collection(db, "employees"), where("name", "==", n), where("pin", "==", p));
      const snap = await getDocs(q);
      if(!snap.empty) {
        currentUserData = snap.docs[0].data();
        localStorage.setItem('sws_user', JSON.stringify(currentUserData));
        startApp();
      } else {
        alert("å§“åæˆ–PINç¢¼éŒ¯èª¤");
        btn.innerText = "ç™»å…¥ç³»çµ±"; btn.disabled = false;
      }
    } catch(e) {
      alert("é€£ç·šéŒ¯èª¤");
      btn.disabled = false;
    }
  };

  function startApp() {
    document.getElementById("userHello").innerText = "ä½ å¥½ï¼Œ" + currentUserData.name;
    showBox('menuBox');
    loadRecords(); // éåŒæ­¥åŠ è¼‰ç´€éŒ„
  }

  // åŠ è¼‰æ‰“å¡ç´€éŒ„
  async function loadRecords() {
    const q = query(collection(db, "punch_logs"), where("name", "==", currentUserData.name), orderBy("timestamp", "desc"));
    const snap = await getDocs(q);
    cachedRecords = snap.docs.map(doc => doc.data());
  }

  window.doLogout = () => {
    localStorage.removeItem('sws_user');
    location.reload();
  };

  // åˆå§‹åŒ–æª¢æŸ¥
  const saved = localStorage.getItem('sws_user');
  if(saved) {
    currentUserData = JSON.parse(saved);
    startApp();
  }
  
  // é€™è£¡éœ€è¦ç¹¼çºŒæ¬é·åŸæœ¬çš„ renderUI, startSchedFlow ç­‰é‚è¼¯ï¼Œ
  // ä½†ç‚ºäº†å…ˆè®“ä½ æ¸¬è©¦ç™»å…¥é€Ÿåº¦ï¼Œæˆ‘å€‘å…ˆç¢ºä¿ç™»å…¥èƒ½è¡Œï¼
</script>
</body>
</html>
